<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Personal Shopper USA ‚Äî estable</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#60a5fa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --chip:#1f2937;
    --card:#0f172a; --accent:#1e293b; --line:#334155;
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu;
       background:linear-gradient(120deg,#0a0f1a,#101726,#0d1422); color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .brand-row{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .app-title{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(145deg,#60a5fa,#22d3ee);
        display:inline-flex;align-items:center;justify-content:center;color:#0b1220;font-weight:900}
  .header-card{background:rgba(255,255,255,0.04);border:1px solid #1f2937;border-radius:14px;padding:12px 14px}
  .toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:6px;background:#0f172a;color:var(--text);
       border:1px solid #334155;border-radius:8px;padding:4px 8px;font-size:12px;line-height:1.1;cursor:pointer;white-space:nowrap}
  .btn:hover{background:#111827} .btn.primary{background:#1d4ed8;border-color:#1d4ed8}
  .btn.success{background:#059669;border-color:#059669} .btn.warn{background:#b45309;border-color:#b45309}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  #btnSync,#btnFetchTRM,#btnManualTRM,#btnHardReload{padding:2px 6px!important;font-size:11px!important;line-height:1.05!important;border-radius:7px!important}
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:repeat(4,1fr)}
  @media(max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:580px){.cards{grid-template-columns:1fr}}
  .card{background:rgba(255,255,255,0.04);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .k{color:var(--muted);font-size:12px}
  .v{font-size:20px;font-weight:700}
  .sub{color:var(--muted);font-size:11px}
  .tabs{display:flex;gap:6px;margin:10px 0 6px}
  .tab{padding:6px 10px;border:1px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:13px}
  .tab.active{background:#1f2937;color:#e5e7eb;border-color:#475569}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}
  .input, select{width:100%;background:#0b1220;color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px;font-size:14px}
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left}
  thead th{position:sticky;top:0;background:#0b1220;z-index:1}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;
        border-radius:999px;padding:2px 8px;font-size:12px}
  .chip.ok{background:rgba(16,185,129,0.12);border-color:#065f46;color:#a7f3d0}
  .chip.warn{background:rgba(245,158,11,0.12);border-color:#78350f;color:#fde68a}
  .chip.bad{background:rgba(239,68,68,0.12);border-color:#7f1d1d;color:#fecaca}
  .progress{height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,#22d3ee,#60a5fa);width:0%}
  .muted{color:var(--muted)}
  .right{text-align:right}
  .hint{font-size:11px;color:#9ca3af;margin-top:4px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #334155;background:#0f172a;font-size:12px;cursor:pointer}
  .pill:hover{background:#111827}
  .err{background:#7f1d1d33;border:1px solid #fca5a5;color:#ffe4e6;padding:8px;border-radius:8px;margin-top:8px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="header-card">
    <div class="brand-row">
      <div class="app-title">
        <div class="logo">PS</div>
        <div>
          <div style="font-weight:800;font-size:18px">Personal Shopper USA ‚Äî estable</div>
          <div class="muted" style="font-size:12px">Control de costos, inventario y viabilidad en tiempo real</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnSync" class="btn" title="Sincronizar con Supabase">‚ü≥ Sync</button>
        <button id="btnFetchTRM" class="btn" title="Actualizar TRM autom√°ticamente">‚áÖ TRM</button>
        <button id="btnManualTRM" class="btn" title="Ingresar TRM manual">‚úç TRM</button>
        <button id="btnHardReload" class="btn" title="Romper cach√© y recargar">‚§≥ Hard-reload</button>
      </div>
    </div>
    <div id="errBox" class="err"></div>
  </div>

  <!-- KPIs -->
  <div class="grid cards" style="margin-top:12px">
    <div class="card">
      <div class="k">Presupuesto Estimado (BT) USD</div>
      <div class="v" id="kpiBT">$7,000.00</div>
      <div class="sub" id="kpiBTcop">‚Äî</div>
    </div>
    <div class="card">
      <div class="k">Costos del viaje (Overheads) USD</div>
      <div class="v" id="kpiV">‚Äî</div>
      <div class="sub" id="kpiVcop">‚Äî</div>
    </div>
    <div class="card">
      <div class="k">Aporte por d√≥lar (V/BT)</div>
      <div class="v" id="kpiRO">‚Äî</div>
      <div class="sub muted">Se usa para VSV</div>
    </div>
    <div class="card">
      <div class="k">TRM vigente</div>
      <div class="v" id="kpiTRM">‚Äî</div>
      <div class="sub">Hist√≥rico por d√≠a</div>
    </div>
  </div>

  <!-- KPIs Presupuesto Real -->
  <div class="grid cards" style="margin-top:12px">
    <div class="card">
      <div class="k">Compras acumuladas (Costo USD)</div>
      <div class="v" id="kpiComprasUSD">‚Äî</div>
      <div class="sub" id="kpiComprasCOP">‚Äî</div>
    </div>
    <div class="card">
      <div class="k">Presupuesto Real Acumulado = Overheads + Compras</div>
      <div class="v" id="kpiRealUSD">‚Äî</div>
      <div class="sub" id="kpiRealCOP">‚Äî</div>
    </div>
    <div class="card" style="grid-column: span 2">
      <div class="k">Uso del presupuesto estimado (BT)</div>
      <div class="progress" style="margin-top:6px"><div id="progBT" style="width:0%"></div></div>
      <div class="sub" id="progBTText" style="margin-top:6px">‚Äî</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="config">‚öôÔ∏è Configuraci√≥n</div>
    <div class="tab" data-tab="catalog">üìö Cat√°logo referencia</div>
    <div class="tab" data-tab="overheads">üíº Overheads</div>
    <div class="tab" data-tab="reportes">üìä Reportes</div>
  </div>

  <!-- Panel Config -->
  <div id="panel-config" class="card">
    <div class="row">
      <div>
        <label>Presupuesto total (BT) USD</label>
        <input id="inpBT" class="input" type="number" step="0.01" value="7000">
      </div>
      <div>
        <label>Margen objetivo GB% (sobre venta)</label>
        <input id="inpGB" class="input" type="number" step="1" value="30">
        <div class="hint">Al cambiar, se recalculan KPIs, sem√°foro, inventario estimado y reportes</div>
      </div>
      <div>
        <label>TRM (COP/USD) ‚Äì d√≠a de hoy (UI)</label>
        <input id="inpTRM" class="input" type="number" step="1" placeholder="Ej: 4200">
      </div>
      <div>
        <label>Notas</label>
        <input id="inpNotes" class="input" placeholder="Opcional">
      </div>
    </div>
  </div>

  <!-- Panel Cat√°logo -->
  <div id="panel-catalog" class="card" style="display:none">
    <div class="k">Base de referencia (VR) en COP. Se usa para comparar en el sem√°foro.</div>
    <div class="row">
      <div>
        <label>Descripci√≥n / SKU</label>
        <input id="catName" class="input" placeholder="Ej: Nike Air Max 90">
      </div>
      <div>
        <label>Marca / Categor√≠a (opcional)</label>
        <input id="catMeta" class="input" placeholder="Nike / Calzado">
      </div>
      <div>
        <label>Precio referencia (COP)</label>
        <input id="catCOP" class="input" type="number" step="100">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="catAdd" class="btn success">Ôºã Agregar</button>
        <button id="catSync" class="btn">‚ü≥ Refrescar</button>
      </div>
    </div>

    <hr style="border:0;border-top:1px solid #1f2937;margin:12px 0">

    <div class="k">Carga masiva (XLSX/CSV). M√≠nimo: <b>name</b>, <b>ref_cop</b>. Opcionales: <b>brand</b>, <b>cat</b>.</div>
    <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input type="file" id="catFile" accept=".xlsx,.xls,.csv"/>
      <button id="catPrevBtn" class="btn">Vista previa</button>
      <button id="catImpBtn" class="btn primary" disabled>Importar (lotes)</button>
    </div>
    <div style="margin-top:8px;max-height:240px;overflow:auto">
      <table>
        <thead><tr><th>#</th><th>name</th><th>brand</th><th>cat</th><th class="right">ref_cop</th><th>OK</th></tr></thead>
        <tbody id="catPrevBody"></tbody>
      </table>
    </div>

    <div style="margin-top:10px;max-height:300px;overflow:auto">
      <table>
        <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Marca/Cat</th><th class="right">COP</th><th>Fuente</th><th>Acciones</th></tr></thead>
        <tbody id="catTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Overheads -->
  <div id="panel-overheads" class="card" style="display:none">
    <div class="k">TRM fijada por fecha; se guardan USD/COP determin√≠sticos. Compatible con esquema legado.</div>
    <div class="row">
      <div>
        <label>Descripci√≥n</label>
        <input id="ohDesc" class="input" placeholder="Tiquetes / Hospedaje / Env√≠o...">
      </div>
      <div>
        <label>Categor√≠a</label>
        <input id="ohCat" class="input" placeholder="Transporte / Env√≠o / ...">
      </div>
      <div>
        <label>Moneda y monto</label>
        <div style="display:flex;gap:6px">
          <select id="ohCur" class="input" style="max-width:110px"><option>USD</option><option>COP</option></select>
          <input id="ohUsd" class="input" type="number" step="0.01" placeholder="Monto">
        </div>
      </div>
      <div>
        <label>Fecha y TRM manual (opcional)</label>
        <div style="display:flex;gap:6px">
          <input id="ohDate" class="input" type="date">
          <input id="ohTRM" class="input" type="number" step="1" placeholder="TRM manual">
        </div>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="ohAdd" class="btn success">Ôºã Agregar costo</button>
        <button id="ohDelSel" class="btn warn">Eliminar seleccionados</button>
      </div>
    </div>

    <div style="margin-top:8px;max-height:320px;overflow:auto">
      <table>
        <thead><tr>
          <th></th><th>Fecha</th><th>Descripci√≥n</th><th>Cat</th><th>Moneda</th>
          <th class="right">Vista</th><th class="right">TRM usada</th>
          <th class="right">USD fijo</th><th class="right">COP fijo</th>
          <th>Acciones</th>
        </tr></thead>
        <tbody id="ohTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Reportes -->
  <div id="panel-reportes" class="card" style="display:none">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <div class="k">Reporte estimado (inventario)</div>
        <div id="repEst">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Reporte realizado (ventas)</div>
        <div id="repReal">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- LIBRER√çAS: UMD para GitHub Pages -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ======= CONFIG SUPABASE ======= */
const SUPABASE_URL = "https://ucrkhrehdedmubykzfzs.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmtocmVoZGVkbXVieWt6ZnpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTc5MzgsImV4cCI6MjA3NzE3MzkzOH0.7CXUuyAPQlm_9RIKbaO9y8Kwjh9c6M7UJcu4xAIM7WA";
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ======= ESTADO ======= */
let BT = 7000;
let GB = 30;
let TRM = 4200;
let OVERHEADS = [];
let CATALOG = [];
let INVENTORY = [];
let SALES = [];
let overheadsFixedSchema = null; // se detecta en runtime
let catalogNeedsTrip = null;     // true si la fila trae trip_id en DB
let lastTripId = null;

/* ======= HELPERS ======= */
const fmtUSD = n => "$" + (Number(n||0)).toFixed(2);
const fmtCOP = n => "$" + (Math.round(Number(n||0))).toLocaleString("es-CO");
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function showErr(msg){ const box=$('#errBox'); box.style.display='block'; box.textContent=msg; setTimeout(()=>{box.style.display='none'}, 7000); }

/* ======= TABS ======= */
$$('.tab').forEach(t=>{
  t.onclick=()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    ['config','catalog','overheads','reportes'].forEach(id=>{
      $('#panel-'+id).style.display = (id===tab?'block':'none');
    });
  };
});

/* ======= KPIs ======= */
function renderKPIs(){
  const VUSD = OVERHEADS.reduce((s,o)=> s + Number(o._usd_fixed||0), 0);
  const comprasUSD = INVENTORY.reduce((s,p)=> s + (Number(p.unit_usd||0)*Number(p.qty||0)), 0);
  const realUSD = VUSD + comprasUSD;

  $('#kpiBT').textContent = fmtUSD(BT);
  $('#kpiBTcop').textContent = fmtCOP(BT*TRM);
  $('#kpiV').textContent = fmtUSD(VUSD);
  $('#kpiVcop').textContent = fmtCOP(VUSD*TRM);
  $('#kpiRO').textContent = (BT>0 ? (VUSD/BT) : 0).toFixed(3);
  $('#kpiTRM').textContent = fmtCOP(TRM) + " COP/USD";

  $('#kpiComprasUSD').textContent = fmtUSD(comprasUSD);
  $('#kpiComprasCOP').textContent = fmtCOP(comprasUSD*TRM);
  $('#kpiRealUSD').textContent = fmtUSD(realUSD);
  $('#kpiRealCOP').textContent = fmtCOP(realUSD*TRM);

  const pct = Math.max(0, Math.min(100, BT>0 ? (realUSD/BT)*100 : 0));
  $('#progBT').style.width = pct.toFixed(1)+"%";
  $('#progBTText').textContent = `Uso de BT: ${pct.toFixed(1)}% ‚Äî Real: ${fmtUSD(realUSD)} de ${fmtUSD(BT)}`;
}

/* ======= SCHEMA DETECTION ======= */
async function detectSchemas(){
  try{
    const r = await supa.from('overheads').select('*').limit(1);
    if(!r.error){
      const row = (r.data||[])[0] || {};
      overheadsFixedSchema = ('amount_usd_fixed' in row) || ('trm_used' in row);
    }
  }catch(e){}
  try{
    const r = await supa.from('catalog').select('*').limit(1);
    if(!r.error){
      const row = (r.data||[])[0] || {};
      catalogNeedsTrip = ('trip_id' in row);
    }
  }catch(e){}
  try{
    const tr = await supa.from('trips').select('id').order('created_at',{ascending:false}).limit(1);
    if(!tr.error && tr.data && tr.data.length){ lastTripId = tr.data[0].id; }
  }catch(e){}
}

/* ======= OVERHEADS ======= */
async function loadOverheads(){
  const {data,error} = await supa.from('overheads').select('*').order('created_at',{ascending:false});
  if(error){ showErr('loadOverheads: '+error.message); return; }
  OVERHEADS = (data||[]).map(o=>{
    // mapa tolerante: soporta esquema nuevo o legado
    const usdFixed = (o.amount_usd_fixed!=null) ? Number(o.amount_usd_fixed)
                   : (o.usd!=null) ? Number(o.usd)
                   : (o.amount_usd!=null && o.trm_used) ? Number(o.amount_usd)
                   : 0;
    const copFixed = (o.amount_cop_fixed!=null) ? Number(o.amount_cop_fixed)
                   : (o.usd!=null && TRM) ? Number(o.usd)*TRM
                   : (o.amount_cop!=null) ? Number(o.amount_cop)
                   : 0;
    return {...o, _usd_fixed:usdFixed, _cop_fixed:copFixed};
  });
  renderOverheads();
  renderKPIs();
}

function renderOverheads(){
  const tb = $('#ohTbody'); tb.innerHTML="";
  OVERHEADS.forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" class="ohchk" value="${o.id}"></td>
      <td>${new Date(o.created_at).toLocaleString('es-CO')}</td>
      <td>${o.description||''}</td>
      <td>${o.cat||''}</td>
      <td>${o.currency|| (overheadsFixedSchema?'‚Äî':'USD')}</td>
      <td class="right">${fmtUSD(o._usd_fixed)}</td>
      <td class="right">${fmtCOP(o.trm_used || TRM)}</td>
      <td class="right">${fmtUSD(o._usd_fixed)}</td>
      <td class="right">${fmtCOP(o._cop_fixed)}</td>
      <td class="center"><button class="btn" data-del="${o.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  // delete 1
  tb.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const r = await supa.from('overheads').delete().eq('id', btn.dataset.del);
      if(r.error){ showErr('Eliminar overhead: '+r.error.message); return; }
      await loadOverheads();
    };
  });
}

// insertar compatible
async function addOverhead(){
  const desc = $('#ohDesc').value.trim();
  const cat = $('#ohCat').value.trim();
  const cur = $('#ohCur').value;
  const amt = Number($('#ohUsd').value||0);
  const dateStr = $('#ohDate').value ? $('#ohDate').value : (new Date()).toISOString().slice(0,10);
  const trmManual = Number($('#ohTRM').value||0) || null;
  if(!desc || !(amt>0)){ alert('Ingresa descripci√≥n y monto'); return; }

  // Asegura TRM del d√≠a en tabla trm_daily si existe la columna en backend (si no, solo UI)
  let trmToUse = trmManual || TRM;
  try{
    const existing = await supa.from('trm_daily').select('*').eq('d', dateStr).maybeSingle();
    if(existing?.data?.trm) trmToUse = Number(existing.data.trm);
    else if(!trmManual){
      // inserta registro trm_daily con TRM UI (no es obligatorio si no existe tabla)
      await supa.from('trm_daily').insert({d:dateStr,trm:TRM}).catch(()=>{});
      trmToUse = TRM;
    }
  }catch(e){}

  // intenta esquema nuevo
  let ins = {
    description:desc, cat:cat||null, currency:cur,
    trm_used: trmToUse
  };
  if(cur==='USD'){
    ins.amount_usd = amt;
    ins.amount_usd_fixed = amt;
    ins.amount_cop_fixed = Math.round(amt*trmToUse);
  }else{
    ins.amount_cop = amt;
    ins.amount_cop_fixed = Math.round(amt);
    ins.amount_usd_fixed = amt/(trmToUse||1);
  }
  try{
    const r = await supa.from('overheads').insert(ins);
    if(r.error) throw r.error;
  }catch(e){
    // fallback a esquema legado { usd }
    try{
      const r2 = await supa.from('overheads').insert({description:desc,cat,usd:(cur==='USD'?amt:amt/TRM)});
      if(r2.error) throw r2.error;
    }catch(e2){
      showErr('addOverhead: '+(e2.message||e2)); return;
    }
  }
  // limpiar UI
  $('#ohDesc').value=''; $('#ohCat').value=''; $('#ohUsd').value=''; $('#ohTRM').value=''; $('#ohDate').value='';
  await loadOverheads();
}

// delete por lote
async function deleteSelectedOverheads(){
  const ids = $$('.ohchk:checked').map(x=>x.value);
  if(!ids.length){ alert('Marca al menos un gasto'); return; }
  if(!confirm(`Eliminar ${ids.length} gastos?`)) return;
  const r = await supa.from('overheads').delete().in('id', ids);
  if(r.error){ showErr('Eliminar seleccionados: '+r.error.message); return; }
  await loadOverheads();
}

/* ======= CAT√ÅLOGO ======= */
async function loadCatalog(){
  const select = catalogNeedsTrip ? 'id,created_at,name,brand,cat,ref_cop,source,trip_id' : '*';
  const {data,error} = await supa.from('catalog').select(select).order('created_at',{ascending:false});
  if(error){ showErr('loadCatalog: '+error.message); return; }
  CATALOG = data||[];
  renderCatalog();
}
function renderCatalog(){
  const tb = $('#catTbody'); tb.innerHTML="";
  CATALOG.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(c.created_at).toLocaleString('es-CO')}</td>
      <td>${c.name||''}</td>
      <td>${(c.brand||'')}${c.cat?(' / '+c.cat):''}</td>
      <td class="right">${fmtCOP(c.ref_cop||0)}</td>
      <td>${c.source||'manual'}</td>
      <td class="center"><button class="btn" data-del="${c.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=async ()=>{
      await supa.from('catalog').delete().eq('id', btn.dataset.del);
      await loadCatalog();
    };
  });
}
$('#catAdd').onclick=async ()=>{
  const name=$('#catName').value.trim();
  const meta=$('#catMeta').value.trim();
  const cop=Number($('#catCOP').value||0);
  if(!name||!cop){ alert('Ingresa descripci√≥n y COP'); return; }
  let brand=null, cat=null;
  if(meta){ const p=meta.split('/').map(s=>s.trim()); brand=p[0]||null; cat=p[1]||null; }
  const row = {name,brand,cat,ref_cop:Math.round(cop),source:'manual'};
  const payload = (catalogNeedsTrip && lastTripId)? {...row, trip_id:lastTripId } : row;
  const r = await supa.from('catalog').insert(payload);
  if(r.error){ showErr('catAdd: '+r.error.message); return; }
  $('#catName').value=''; $('#catMeta').value=''; $('#catCOP').value='';
  await loadCatalog();
};
$('#catSync').onclick = loadCatalog;

/* ======= IMPORTAR CAT√ÅLOGO XLSX ======= */
let CAT_PREVIEW = [];
function normRef(v){
  if(v==null) return NaN;
  const s = String(v).replace(/[^\d,.,,]/g,'').trim();
  if(!s) return NaN;
  // 1.234.567,89  /  1234567.89
  const comma=(s.match(/,/g)||[]).length, dot=(s.match(/\./g)||[]).length;
  let t=s;
  if(comma && dot){ t=s.replace(/\./g,'').replace(',', '.'); }
  return Number(t);
}
function mapRow(o){
  const name =(o.name??o.Nombre??o.NOMBRE??'').toString().trim();
  const brand=(o.brand??o.Marca??'').toString().trim()||null;
  const cat  =(o.cat??o.Categoria??'').toString().trim()||null;
  const ref  = normRef(o.ref_cop??o['VR COP']??o.VR??o.ref??o.precio);
  return { ok: !!(name && ref>0), row:{ name, brand, cat, ref_cop: Math.round(ref), source:'manual' } };
}
function renderCatPreview(){
  const tb = $('#catPrevBody'); tb.innerHTML='';
  CAT_PREVIEW.forEach((r,i)=>{
    const bad = r.ok?'':' style="color:#fca5a5"';
    const tr=document.createElement('tr');
    tr.innerHTML = `<td${bad}>${i+1}</td><td${bad}>${r.row.name}</td><td${bad}>${r.row.brand||''}</td><td${bad}>${r.row.cat||''}</td><td class="right"${bad}>${fmtCOP(r.row.ref_cop||0)}</td><td${bad}>${r.ok?'‚úì':'Err'}</td>`;
    tb.appendChild(tr);
  });
  $('#catImpBtn').disabled = CAT_PREVIEW.filter(x=>x.ok).length===0;
}
$('#catPrevBtn').onclick = ()=>{
  const f = $('#catFile').files[0];
  if(!f){ alert('Selecciona archivo XLSX/CSV'); return; }
  const reader=new FileReader();
  reader.onload = e=>{
    try{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
      CAT_PREVIEW = rows.map(mapRow);
      renderCatPreview();
    }catch(err){ showErr('Vista previa: '+err.message); }
  };
  reader.readAsArrayBuffer(f);
};
$('#catImpBtn').onclick = async ()=>{
  const ok = CAT_PREVIEW.filter(x=>x.ok).map(x=>x.row);
  if(!ok.length){ alert('Nada para importar'); return; }
  // aplica trip_id si es requerido
  const payload = (catalogNeedsTrip && lastTripId) ? ok.map(r=>({...r,trip_id:lastTripId})) : ok;
  try{
    for(let i=0;i<payload.length;i+=500){
      const chunk = payload.slice(i,i+500);
      const ins = await supa.from('catalog').insert(chunk);
      if(ins.error) throw ins.error;
    }
    alert('Cat√°logo importado');
    $('#catPrevBody').innerHTML=''; $('#catImpBtn').disabled=true; $('#catFile').value='';
    await loadCatalog();
  }catch(e){ showErr('Importar cat√°logo: '+(e.message||e)); }
};

/* ======= TRM ======= */
async function fetchTRM(){
  try{
    const r = await fetch('https://open.er-api.com/v6/latest/USD');
    const j = await r.json();
    if(j && j.rates && j.rates.COP){
      TRM = Number(j.rates.COP);
      $('#inpTRM').value = TRM;
      renderKPIs();
      alert('TRM actualizada');
    }else throw new Error('Sin rates');
  }catch(e){ showErr('TRM: '+e.message); }
}
$('#btnFetchTRM').onclick=fetchTRM;
$('#btnManualTRM').onclick=()=>{
  const v=prompt('TRM (COP/USD):', String(TRM));
  if(v){ TRM=Number(v); $('#inpTRM').value=TRM; renderKPIs(); }
};
$('#inpTRM').onchange=()=>{ const v=Number($('#inpTRM').value||0); if(v>0){ TRM=v; renderKPIs(); } };

/* ======= SYNC ======= */
async function syncAll(){
  await detectSchemas();
  await Promise.all([loadOverheads(), loadCatalog()]).catch(e=>showErr('sync: '+e.message));
  renderKPIs();
}
$('#btnSync').onclick = syncAll;

/* ======= CONFIG LISTENERS ======= */
$('#inpBT').onchange=()=>{ BT = Number($('#inpBT').value||7000); renderKPIs(); };
$('#inpGB').onchange=()=>{ GB = Number($('#inpGB').value||30); renderKPIs(); };

/* ======= OVERHEADS eventos ======= */
$('#ohAdd').onclick = addOverhead;
$('#ohDelSel').onclick = deleteSelectedOverheads;

/* ======= HARD RELOAD ======= */
$('#btnHardReload').onclick = ()=>{
  const u = new URL(location.href);
  u.searchParams.set('v', Date.now());
  location.href = u.toString();
};

/* ======= INIT ======= */
(async function init(){
  try{
    $('#inpBT').value = BT;
    $('#inpGB').value = GB;
    $('#inpTRM').value = TRM;
    await syncAll();
  }catch(e){ showErr('init: '+(e.message||e)); }
})();
</script>
</body>
</html>
