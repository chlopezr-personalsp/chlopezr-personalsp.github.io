<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PS Arbitraje ‚Äì estable</title>
<style>
:root{--bg:#0a0f1a;--panel:#0f172a;--line:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--brand:#60a5fa}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(120deg,#0a0f1a,#0d1422);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto}
.wrap{max-width:1280px;margin:0 auto;padding:12px}
.card{background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:12px;padding:12px}
.row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.k{font-size:12px;color:var(--muted)} .v{font-size:20px;font-weight:800}
.btn{background:#0f172a;border:1px solid #334155;color:var(--text);border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
.btn:hover{background:#111827} .btn.primary{background:#1d4ed8;border-color:#1d4ed8} .btn.success{background:#059669;border-color:#059669} .btn.warn{background:#b45309;border-color:#b45309}
.input,select{background:#0b1220;color:var(--text);border:1px solid #334155;border-radius:10px;padding:8px;width:100%}
table{width:100%;border-collapse:collapse;font-size:13px} th,td{padding:8px 6px;border-bottom:1px solid #1f2937}
thead th{position:sticky;top:0;background:#0b1220;z-index:1}
.tabs{display:flex;gap:6px;margin:10px 0 6px} .tab{padding:6px 10px;border:1px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:13px}
.tab.active{background:#1f2937;border-color:#475569}
.grid{display:grid;gap:10px} .g2{grid-template-columns:1fr 1fr} .g4{grid-template-columns:repeat(4,1fr)}
@media(max-width:900px){.g2{grid-template-columns:1fr}.g4{grid-template-columns:repeat(2,1fr)}}
.progress{height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,#22d3ee,#60a5fa);width:0%}
.logo{width:26px;height:26px;border-radius:8px;background:linear-gradient(145deg,#60a5fa,#22d3ee);display:inline-flex;align-items:center;justify-content:center;color:#0a0f1a;font-weight:900}
.badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;border:1px solid #334155;background:#0f172a;font-size:12px}
.err{background:#7f1d1d;border:1px solid #fecaca;color:#ffe4e6;padding:8px;border-radius:8px}
.right{text-align:right}
</style>
</head>
<body>
<div class="wrap">

  <!-- Error banner -->
  <div id="errBox" class="err" style="display:none"></div>

  <!-- HEADER -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="logo">PS</div>
        <div style="margin-left:8px">
          <div style="font-weight:800">PS Arbitraje ‚Äì estable</div>
          <div class="k">TRM fijada por registro ¬∑ sin RPC ¬∑ con autodiagn√≥stico</div>
        </div>
      </div>
      <div class="row">
        <select id="tripSel" class="input" style="min-width:260px"></select>
        <button id="btnNewTrip" class="btn">+ Nuevo</button>
        <button id="btnDupTrip" class="btn">üìÑ Duplicar</button>
        <span class="k" id="lastUpd"></span>
      </div>
      <div class="row">
        <button id="viewUSD" class="btn primary">USD</button>
        <button id="viewCOP" class="btn">COP</button>
        <button id="btnSync" class="btn">‚ü≥ Sync</button>
        <button id="btnTRM" class="btn">‚áÖ TRM (hoy)</button>
        <button id="btnHard" class="btn">‚§≥ Hard-reload</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row" style="margin-top:8px">
    <div class="card" style="flex:1 1 260px"><div class="k">BT (USD)</div><div class="v" id="kBT">‚Äî</div><div class="k" id="kBTcop">‚Äî</div></div>
    <div class="card" style="flex:1 1 260px"><div class="k">Overheads (USD)</div><div class="v" id="kOv">‚Äî</div><div class="k" id="kOvCop">‚Äî</div></div>
    <div class="card" style="flex:1 1 260px"><div class="k">rO Overheads/BT</div><div class="v" id="kRO">‚Äî</div><div class="k">Se usa en VSV</div></div>
    <div class="card" style="flex:1 1 260px"><div class="k">TRM UI</div><div class="v" id="kTRM">‚Äî</div><div class="k">Fijada por registro</div></div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <div class="tab active" data-tab="config">‚öôÔ∏è Config</div>
    <div class="tab" data-tab="catalog">üìö Cat√°logo</div>
    <div class="tab" data-tab="overheads">üíº Overheads</div>
    <div class="tab" data-tab="reportes">üìä Reportes</div>
    <div class="tab" data-tab="diag">ü©∫ Self-check</div>
  </div>

  <!-- CONFIG -->
  <div id="panel-config" class="card">
    <div class="grid g2">
      <div><label class="k">BT (USD)</label><input id="inpBT" class="input" type="number" step="0.01"></div>
      <div><label class="k">Margen objetivo (GB%)</label><input id="inpGB" class="input" type="number" step="1"></div>
      <div><label class="k">TRM por defecto (UI)</label><input id="inpTRM" class="input" type="number" step="1"><div class="k">Solo UI. Cada registro guarda su TRM.</div></div>
      <div style="display:flex;align-items:end"><button id="btnSaveCfg" class="btn success">üíæ Guardar configuraci√≥n</button></div>
    </div>
  </div>

  <!-- CATALOGO -->
  <div id="panel-catalog" class="card" style="display:none">
    <div class="k">Alta manual</div>
    <div class="grid g4" style="margin-top:6px">
      <input id="cName" class="input" placeholder="Nombre / modelo">
      <input id="cBrand" class="input" placeholder="Marca (opcional)">
      <input id="cCat" class="input" placeholder="Categor√≠a (opcional)">
      <div class="row" style="gap:6px">
        <input id="cRef" class="input" type="number" step="100" placeholder="VR COP">
        <button id="btnCatAdd" class="btn success">Ôºã Agregar</button>
      </div>
    </div>
    <hr style="border:0;border-top:1px solid #1f2937;margin:12px 0">
    <div class="k">Carga masiva (XLSX/CSV): vista previa ‚Üí importar</div>
    <div class="row" style="margin-top:6px">
      <input type="file" id="fileCat" accept=".xlsx,.xls,.csv"/>
      <button id="btnPrev" class="btn">Vista previa</button>
      <button id="btnImp" class="btn primary" disabled>Importar</button>
      <span class="k">M√≠nimo: <span class="badge">name</span> <span class="badge">ref_cop</span></span>
    </div>
    <div style="max-height:220px;overflow:auto;margin-top:6px">
      <table><thead><tr><th>#</th><th>Nombre</th><th>Marca</th><th>Cat</th><th class="right">VR COP</th><th>Ok</th></tr></thead><tbody id="catPrev"></tbody></table>
    </div>
    <div style="max-height:340px;overflow:auto;margin-top:10px">
      <table>
        <thead><tr><th>Fecha</th><th>Nombre</th><th>Marca/Cat</th><th class="right">VR COP</th><th>Fuente</th><th>Acciones</th></tr></thead>
        <tbody id="catBody"></tbody>
      </table>
    </div>
  </div>

  <!-- OVERHEADS -->
  <div id="panel-overheads" class="card" style="display:none">
    <div class="k">TRM fijada por fecha; se guardan USD/COP determin√≠sticos.</div>
    <div class="grid g4" style="margin-top:6px">
      <input id="ohDesc" class="input" placeholder="Descripci√≥n (tiquetes, hotel, env√≠o‚Ä¶)">
      <input id="ohCat" class="input" placeholder="Categor√≠a">
      <div class="row" style="gap:6px;flex:1">
        <select id="ohCur" class="input" style="flex:0 0 110px"><option>USD</option><option>COP</option></select>
        <input id="ohAmt" class="input" type="number" step="0.01" placeholder="Monto">
      </div>
      <div class="row" style="gap:6px;flex:1">
        <input id="ohDate" class="input" type="date" style="flex:1">
        <input id="ohTRM" class="input" type="number" step="1" placeholder="TRM manual (opcional)" style="flex:1">
      </div>
      <div style="grid-column:1/-1;display:flex;gap:8px">
        <button id="btnOhAdd" class="btn success">Ôºã Agregar</button>
        <button id="btnOhDelSel" class="btn warn">Eliminar seleccionados</button>
      </div>
    </div>
    <div style="max-height:340px;overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th></th><th>Fecha</th><th>Desc</th><th>Cat</th><th>Moneda</th>
            <th class="right">Vista</th><th class="right">TRM usada</th>
            <th class="right">USD fijo</th><th class="right">COP fijo</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="ohBody"></tbody>
      </table>
    </div>
  </div>

  <!-- REPORTES -->
  <div id="panel-reportes" class="card" style="display:none">
    <div class="grid g2">
      <div class="card">
        <div class="k">Uso de BT</div>
        <div class="progress" style="margin-top:6px"><div id="progBT"></div></div>
        <div class="k" id="progTxt" style="margin-top:6px">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Resumen</div>
        <div id="repBox">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- DIAGN√ìSTICO -->
  <div id="panel-diag" class="card" style="display:none">
    <div class="k">Self-check (conexi√≥n y tablas). Si algo falla se muestra aqu√≠ y en el banner rojo.</div>
    <pre id="diagBox" style="white-space:pre-wrap;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:8px;margin-top:8px;max-height:300px;overflow:auto">‚Äî</pre>
  </div>

</div>

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===== Config Supabase ===== */
const URL='https://ucrkhrehdedmubykzfzs.supabase.co';
const KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmtocmVoZGVkbXVieWt6ZnpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTc5MzgsImV4cCI6MjA3NzE3MzkzOH0.7CXUuyAPQlm_9RIKbaO9y8Kwjh9c6M7UJcu4xAIM7WA';
const sb = window.supabase.createClient(URL, KEY);

/* ===== Estado ===== */
let trips=[], activeTrip=null, settings=null, TRM_UI=4200, VIEW='USD';
let OVERHEADS=[], CATALOG=[];
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const fmtUSD=n=>"$"+Number(n||0).toFixed(2);
const fmtCOP=n=>"$"+Math.round(Number(n||0)).toLocaleString("es-CO");
const fmtDate=iso=>iso? new Date(iso).toLocaleDateString('es-CO'):'‚Äî';
const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* ===== Manejo de errores visible ===== */
function showErr(msg){ const b=$('#errBox'); b.textContent=msg; b.style.display='block'; }
window.addEventListener('error',e=>showErr('JS error: '+(e?.message||e)));
window.addEventListener('unhandledrejection',e=>showErr('Promise error: '+(e?.reason?.message||e?.reason||e)));

/* ===== Util ===== */
function sumOverheadsUSD(){ return OVERHEADS.reduce((s,o)=>s+Number(o.amount_usd_fixed||0),0); }
function aportePorDolar(){ const V=sumOverheadsUSD(); const BT=settings?.bt_usd||0; return BT>0? (V/BT):0; }
function renderKPIs(){
  const BT=settings?.bt_usd||0, VUSD=sumOverheadsUSD();
  $('#kBT').textContent=fmtUSD(BT); $('#kBTcop').textContent=fmtCOP(BT*TRM_UI);
  $('#kOv').textContent=fmtUSD(VUSD); $('#kOvCop').textContent=fmtCOP(VUSD*TRM_UI);
  $('#kRO').textContent=aportePorDolar().toFixed(3); $('#kTRM').textContent=fmtCOP(TRM_UI)+' COP/USD';
  const pct=Math.max(0,Math.min(100,BT? (VUSD/BT)*100:0));
  $('#progBT').style.width=pct.toFixed(1)+'%'; $('#progTxt').textContent=`Uso de BT: ${pct.toFixed(1)}% ‚Äî ${fmtUSD(VUSD)} de ${fmtUSD(BT)}`;
  $('#repBox').innerHTML=`<div>Overheads USD: <b>${fmtUSD(VUSD)}</b></div><div>Overheads COP: <b>${fmtCOP(VUSD*TRM_UI)}</b></div><div>rO: <b>${aportePorDolar().toFixed(3)}</b></div>`;
}
function setView(v){ VIEW=v; $('#viewUSD').classList.toggle('primary',v==='USD'); $('#viewCOP').classList.toggle('primary',v==='COP'); renderOH(); }

/* ===== Trips ===== */
async function loadTrips(){
  const {data,error}=await sb.from('trips').select('id,name,created_at').order('created_at',{ascending:false});
  if(error){ showErr('loadTrips: '+error.message); return; }
  trips=data||[];
  const sel=$('#tripSel'); sel.innerHTML="";
  trips.forEach(t=>{const o=document.createElement('option');o.value=t.id;o.textContent=`${t.name} (#${t.id})`;sel.appendChild(o);});
  if(!activeTrip && trips.length) activeTrip=trips[0].id;
  if(activeTrip) sel.value=activeTrip;
}
async function createTrip(){
  const name=prompt('Nombre del viaje/proyecto:','Orlando Nov 7 2025'); if(!name) return;
  const {data,error}=await sb.from('trips').insert({name}).select().single();
  if(error){ showErr('createTrip: '+error.message); return; }
  activeTrip=data.id;
  await sb.from('trip_settings').insert({trip_id:activeTrip}).onConflict('trip_id').ignore();
  await loadTrips(); await loadSettings(); await reloadAll();
}
async function duplicateTrip(){
  if(!activeTrip){ alert('Selecciona un viaje'); return; }
  const name=prompt('Nombre del nuevo viaje (duplicado):','Copia'); if(!name) return;
  const r=await sb.from('trips').insert({name}).select().single(); if(r.error){ showErr('dupTrip: '+r.error.message); return; }
  const newId=r.data.id;
  await sb.from('trip_settings').insert({trip_id:newId}).onConflict('trip_id').ignore();
  const cat=await sb.from('catalog').select('name,brand,cat,ref_cop,source').eq('trip_id',activeTrip);
  if(!cat.error && cat.data?.length){ for(let i=0;i<cat.data.length;i+=500){ await sb.from('catalog').insert(cat.data.slice(i,i+500).map(x=>({trip_id:newId,...x}))); } }
  const oh=await sb.from('overheads').select('description,cat,currency,amount_usd,amount_cop,trm_used,amount_usd_fixed,amount_cop_fixed').eq('trip_id',activeTrip);
  if(!oh.error && oh.data?.length){ for(const o of oh.data){ await sb.from('overheads').insert({trip_id:newId,...o}); } }
  activeTrip=newId; await loadTrips(); await loadSettings(); await reloadAll();
}

/* ===== Settings ===== */
async function loadSettings(){
  if(!activeTrip) return;
  let r=await sb.from('trip_settings').select('*').eq('trip_id',activeTrip).maybeSingle();
  if(r.error){ showErr('loadSettings: '+r.error.message); return; }
  if(!r.data){ await sb.from('trip_settings').insert({trip_id:activeTrip}); r=await sb.from('trip_settings').select('*').eq('trip_id',activeTrip).single(); }
  settings=r.data; TRM_UI=settings.default_trm||4200;
  $('#inpBT').value=settings.bt_usd||7000; $('#inpGB').value=settings.gb_pct||30; $('#inpTRM').value=TRM_UI;
  $('#lastUpd').textContent='Actualizado: '+new Date(settings.updated_at||Date.now()).toLocaleString('es-CO');
  renderKPIs();
}
async function saveSettings(){
  if(!activeTrip) return;
  const obj={ bt_usd:Number($('#inpBT').value||0), gb_pct:Number($('#inpGB').value||0), default_trm:Number($('#inpTRM').value||0), updated_at:new Date().toISOString() };
  const r=await sb.from('trip_settings').upsert({trip_id:activeTrip, ...obj}).select();
  if(r.error){ showErr('saveSettings: '+r.error.message); return; }
  await loadSettings(); await reloadAll();
}

/* ===== TRM ===== */
async function fetchTRM(){
  try{
    const r=await fetch('https://open.er-api.com/v6/latest/USD'); const j=await r.json();
    if(j?.rates?.COP){ TRM_UI=Number(j.rates.COP); $('#inpTRM').value=TRM_UI; renderKPIs(); }
    else throw new Error('Sin rates');
  }catch(e){ showErr('TRM: '+e.message); }
}

/* ===== Overheads ===== */
function renderOH(){
  const tb=$('#ohBody'); tb.innerHTML="";
  OVERHEADS.forEach(o=>{
    const viewUSD = VIEW==='USD';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="checkbox" class="ohchk" value="${o.id}"></td>
      <td>${fmtDate(o.created_at)}</td>
      <td>${esc(o.description||'')}</td>
      <td>${esc(o.cat||'')}</td>
      <td>${o.currency||'‚Äî'}</td>
      <td class="right">${viewUSD? fmtUSD(o.amount_usd_fixed) : fmtCOP(o.amount_cop_fixed)}</td>
      <td class="right">${fmtCOP(o.trm_used)} COP</td>
      <td class="right">${fmtUSD(o.amount_usd_fixed)}</td>
      <td class="right">${fmtCOP(o.amount_cop_fixed)}</td>
      <td><button class="btn warn" data-del="${o.id}">üóë</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{
    const r=await sb.from('overheads').delete().eq('id',b.dataset.del);
    if(r.error){ showErr('del OH: '+r.error.message); return; }
    await loadOH(); renderKPIs();
  });
}
async function loadOH(){
  if(!activeTrip) return;
  const r=await sb.from('overheads').select('*').eq('trip_id',activeTrip).order('created_at',{ascending:false});
  if(r.error){ showErr('loadOH: '+r.error.message); return; }
  OVERHEADS=r.data||[]; renderOH(); renderKPIs();
}
async function ensureTRM(dateISO, manualTRM){
  const d=dateISO; if(!d) return TRM_UI;
  if(manualTRM){ await sb.from('trm_daily').upsert({d, trm:manualTRM}); return manualTRM; }
  const row=(await sb.from('trm_daily').select('*').eq('d',d).maybeSingle()).data;
  if(row) return Number(row.trm);
  await sb.from('trm_daily').insert({d, trm:TRM_UI});
  return TRM_UI;
}
async function addOH(){
  if(!activeTrip) return;
  const desc=$('#ohDesc').value.trim(), cat=$('#ohCat').value.trim(), cur=$('#ohCur').value, amt=Number($('#ohAmt').value||0);
  const dStr=$('#ohDate').value? $('#ohDate').value : (new Date()).toISOString().slice(0,10);
  const trmMan=$('#ohTRM').value? Number($('#ohTRM').value):null;
  if(!desc || !(amt>0)){ alert('Ingresa descripci√≥n y monto'); return; }
  const trm = await ensureTRM(dStr, trmMan);
  let amount_usd=null, amount_cop=null, usd_fixed=null, cop_fixed=null;
  if(cur==='USD'){ amount_usd=amt; usd_fixed=amt; cop_fixed=amt*trm; }
  else { amount_cop=amt; usd_fixed=amt/(trm||1); cop_fixed=amt; }
  const r=await sb.from('overheads').insert({
    trip_id:activeTrip, description:desc, cat:cat||null, currency:cur,
    amount_usd, amount_cop, trm_used:trm, amount_usd_fixed:usd_fixed, amount_cop_fixed:cop_fixed
  });
  if(r.error){ showErr('addOH: '+r.error.message); return; }
  $('#ohDesc').value=''; $('#ohCat').value=''; $('#ohAmt').value=''; $('#ohTRM').value='';
  await loadOH(); renderKPIs();
}
async function delSelectedOH(){
  const ids=$$('.ohchk:checked').map(x=>x.value);
  if(!ids.length){ alert('Marca al menos un gasto'); return; }
  if(!confirm(`Eliminar ${ids.length} gastos?`)) return;
  const r=await sb.from('overheads').delete().in('id',ids);
  if(r.error){ showErr('delSelectedOH: '+r.error.message); return; }
  await loadOH(); renderKPIs();
}

/* ===== Catalog ===== */
async function loadCatalog(){
  if(!activeTrip) return;
  const r=await sb.from('catalog').select('*').eq('trip_id',activeTrip).order('created_at',{ascending:false});
  if(r.error){ showErr('loadCatalog: '+r.error.message); return; }
  CATALOG=r.data||[]; renderCatalog();
}
function renderCatalog(){
  const tb=$('#catBody'); tb.innerHTML="";
  CATALOG.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmtDate(c.created_at)}</td>
      <td>${esc(c.name)}</td><td>${esc(c.brand||'')}${c.cat?(' / '+esc(c.cat)) : ''}</td>
      <td class="right">${fmtCOP(c.ref_cop||0)}</td><td>${esc(c.source||'manual')}</td>
      <td><button class="btn warn" data-del="${c.id}">üóë</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{
    const r=await sb.from('catalog').delete().eq('id',b.dataset.del);
    if(r.error){ showErr('del catalog: '+r.error.message); return; }
    await loadCatalog();
  });
}
async function addCatalogManual(){
  const name=$('#cName').value.trim(), brand=($('#cBrand').value||'').trim()||null, cat=($('#cCat').value||'').trim()||null, ref=Number($('#cRef').value||0);
  if(!name||!(ref>0)){ alert('Nombre y VR COP'); return; }
  const r=await sb.from('catalog').insert({trip_id:activeTrip,name,brand,cat,ref_cop:ref,source:'manual'});
  if(r.error){ showErr('add catalog: '+r.error.message); return; }
  $('#cName').value=''; $('#cBrand').value=''; $('#cCat').value=''; $('#cRef').value='';
  await loadCatalog();
}

/* ===== Import XLSX ===== */
let previewRows=[];
function mapRow(o){
  const name=(o.name??o.Nombre??o.nombre??'').toString().trim();
  const brand=(o.brand??o.Marca??o.marca??'').toString().trim()||null;
  const cat  =(o.cat??o.Categoria??o.categoria??'').toString().trim()||null;
  const refRaw=(o.ref_cop??o.VR??o['VR COP']??o.ref??o.precio??'').toString();
  const ref=Number(refRaw.replace(/[^\d.,]/g,'').replace(',','.'));
  return {ok: !!(name&&ref>0), row:{trip_id:activeTrip,name,brand,cat,ref_cop:ref,source:'manual'}};
}
function renderPreview(){
  const tb=$('#catPrev'); tb.innerHTML="";
  previewRows.forEach((r,i)=>{
    const bad=r.ok?'':' style="color:#fca5a5"';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td${bad}>${i+1}</td><td${bad}>${esc(r.row.name)}</td><td${bad}>${esc(r.row.brand||'')}</td><td${bad}>${esc(r.row.cat||'')}</td><td class="right"${bad}>${r.row.ref_cop?fmtCOP(r.row.ref_cop):'‚Äî'}</td><td${bad}>${r.ok?'‚úì':'Err'}</td>`;
    tb.appendChild(tr);
  });
  $('#btnImp').disabled = previewRows.filter(x=>x.ok).length===0;
}
async function previewFile(){
  const f=$('#fileCat').files[0]; if(!f){ alert('Selecciona archivo'); return; }
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
      previewRows=rows.map(mapRow); renderPreview();
    }catch(err){ showErr('preview XLSX: '+err.message); }
  };
  reader.readAsArrayBuffer(f);
}
async function importPreview(){
  const rows=previewRows.filter(x=>x.ok).map(x=>x.row);
  if(!rows.length){ alert('Nada para importar'); return; }
  try{
    for(let i=0;i<rows.length;i+=500){ const chunk=rows.slice(i,i+500); const r=await sb.from('catalog').insert(chunk); if(r.error) throw r.error; }
    alert('Importado'); $('#catPrev').innerHTML=''; $('#btnImp').disabled=true; $('#fileCat').value='';
    await loadCatalog();
  }catch(e){ showErr('import XLSX: '+(e.message||e)); }
}

/* ===== Sync, Tabs y Diag ===== */
async function reloadAll(){ await Promise.all([loadOH(), loadCatalog()]).catch(e=>showErr('reloadAll: '+e.message)); renderKPIs(); }
function switchTab(id){ $$('.tab').forEach(t=>t.classList.toggle('active', t.dataset.tab===id)); ['config','catalog','overheads','reportes','diag'].forEach(p=>$('#panel-'+p).style.display = (p===id?'block':'none')); }
async function runDiag(){
  const out=[];
  async function log(title, fn){
    try{ const r=await fn(); out.push(`‚úî ${title}: OK (${(r.data||[]).length} filas)`); }
    catch(e){ out.push(`‚úñ ${title}: ${e.message||e}`); showErr(`${title}: ${e.message||e}`); }
  }
  await log('trips', ()=>sb.from('trips').select('id').limit(3));
  await log('trip_settings', ()=>sb.from('trip_settings').select('trip_id').limit(3));
  await log('trm_daily', ()=>sb.from('trm_daily').select('d,trm').limit(3));
  await log('overheads', ()=>sb.from('overheads').select('id').limit(3));
  await log('catalog', ()=>sb.from('catalog').select('id').limit(3));
  $('#diagBox').textContent=out.join('\n');
}

/* ===== Eventos ===== */
$('#tripSel').onchange=async()=>{ activeTrip=Number($('#tripSel').value); await loadSettings(); await reloadAll(); };
$('#btnNewTrip').onclick=createTrip;
$('#btnDupTrip').onclick=duplicateTrip;
$('#viewUSD').onclick=()=>setView('USD'); $('#viewCOP').onclick=()=>setView('COP');
$('#btnSync').onclick=reloadAll;
$('#btnTRM').onclick=fetchTRM;
$('#btnHard').onclick=()=>{ const u=new URL(location.href); u.searchParams.set('v',Date.now()); location.href=u.toString(); };
$('#btnSaveCfg').onclick=saveSettings;
$('#btnOhAdd').onclick=addOH; $('#btnOhDelSel').onclick=delSelectedOH;
$('#btnCatAdd').onclick=addCatalogManual; $('#btnPrev').onclick=previewFile; $('#btnImp').onclick=importPreview;
$$('.tab').forEach(t=> t.onclick=()=>{ switchTab(t.dataset.tab); if(t.dataset.tab==='diag') runDiag(); });

/* ===== Init ===== */
(async function init(){
  await loadTrips();
  if(!activeTrip && trips.length===0){ await createTrip(); return; }
  await loadSettings();
  await reloadAll();
  setView('USD');
})();
</script>
</body>
</html>
