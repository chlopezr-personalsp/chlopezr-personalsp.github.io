<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PS ¬∑ Viajes/Arbitraje</title>
<meta name="theme-color" content="#0b0f14"/>
<style>
  :root { color-scheme: dark; --bg:#0b0f14; --panel:#121821; --txt:#e6edf3; --muted:#94a3b8; --brand:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#1f2937; }
  *{box-sizing:border-box} body{margin:0;font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter;background:var(--bg);color:var(--txt)}
  header{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,15,20,.8);backdrop-filter:saturate(160%) blur(8px)}
  .logo{font-weight:700;letter-spacing:.3px}
  select, input, button, textarea{background:#0f1620;border:1px solid #223043;color:var(--txt);padding:8px 10px;border-radius:10px}
  button{cursor:pointer}
  button.small{padding:6px 8px;font-size:12px}
  .primary{background:linear-gradient(180deg,#1e293b,#0f172a);border-color:#293445}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi b{font-size:18px}
  nav.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 12px}
  nav.tabs button{border-radius:12px}
  .tab{display:none;margin:12px}
  .tab.active{display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:top}
  th{color:#cbd5e1;font-weight:600}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grow{flex:1}
  .right{margin-left:auto}
  .danger{color:var(--err)}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .pill{padding:3px 8px;border:1px solid #2a3a51;border-radius:999px;color:#cbd5e1;font-size:12px}
  .toggle{display:inline-flex;gap:6px;align-items:center}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0f1620;border-radius:8px;padding:2px 6px}
  .hidden{display:none!important}
  .hr{height:1px;background:#1f2937;margin:8px 0}
  .img-preview{max-width:200px;max-height:160px;border:1px dashed #334155;border-radius:10px;object-fit:contain}
</style>
</head>
<body>

<header>
  <div class="logo">üÖøÔ∏èüÜÇ <span class="muted">Arbitraje</span></div>
  <select id="tripSelect"></select>
  <button id="btnNewTrip" class="small primary">+ Nuevo viaje</button>
  <button id="btnDupTrip" class="small">‚éò Duplicar‚Ä¶</button>
  <span class="right"></span>
  <span class="muted small">Moneda vista:</span>
  <div class="toggle">
    <button id="viewUSD" class="small pill">USD</button>
    <button id="viewCOP" class="small pill">COP</button>
  </div>
  <button id="btnSync" class="small">‚ü≥ Sync</button>
  <button id="btnTRM" class="small">‚áÖ TRM (hoy)</button>
</header>

<div class="grid cols-4" style="padding:12px">
  <div class="panel kpi"><span class="muted">BT (USD)</span><b id="kpiBT">‚Äî</b><span class="muted" id="kpiUpdated">Actualizado: ‚Äî</span></div>
  <div class="panel kpi"><span class="muted">Overheads</span><b id="kpiOV">‚Äî</b><span class="muted">rO = Overheads / BT</span><b id="kpiRO">‚Äî</b></div>
  <div class="panel kpi"><span class="muted">Compras acumuladas</span><b id="kpiCompras">‚Äî</b><span class="muted">Vista: <span id="lblVista"></span></span></div>
  <div class="panel kpi"><span class="muted">TRM del d√≠a</span><b id="kpiTRM">‚Äî</b><span class="muted">Fijada por registro</span></div>
</div>

<nav class="tabs">
  <button data-tab="cfg" class="small primary">Configuraci√≥n</button>
  <button data-tab="cat" class="small">Cat√°logo</button>
  <button data-tab="sem" class="small">Sem√°foro (OCR/ML)</button>
  <button data-tab="inv" class="small">Inventario</button>
  <button data-tab="ven" class="small">Ventas</button>
  <button data-tab="rep" class="small">Reportes</button>
</nav>

<!-- CONFIGURACI√ìN -->
<section id="tab-cfg" class="tab active">
  <div class="panel">
    <div class="row">
      <div class="grow">
        <label>Margen objetivo GB%</label>
        <input id="inpGB" type="number" step="0.1" min="0" max="95" placeholder="30"/>
      </div>
      <div class="grow">
        <label>BT (USD)</label>
        <input id="inpBT" type="number" step="0.01" min="0" placeholder="7000"/>
      </div>
      <div class="grow">
        <label>TRM por defecto (UI)</label>
        <input id="inpTRMDef" type="number" step="0.01" min="0" placeholder="4200"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSaveCfg" class="primary">Guardar configuraci√≥n</button>
      <span class="muted">Se persiste por viaje en <span class="code">trip_settings</span></span>
    </div>
  </div>

  <div class="panel" style="margin-top:10px">
    <div class="row">
      <div class="grow">
        <label>Overhead: descripci√≥n</label>
        <input id="ovDesc" placeholder="Tiquetes, hotel, env√≠o, etc."/>
      </div>
      <div class="grow">
        <label>Categor√≠a</label>
        <input id="ovCat" placeholder="log√≠stica, transporte, aduana‚Ä¶"/>
      </div>
      <div>
        <label>Moneda</label>
        <select id="ovCur"><option>USD</option><option>COP</option></select>
      </div>
      <div>
        <label>Monto</label>
        <input id="ovAmt" type="number" step="0.01" min="0"/>
      </div>
      <div>
        <label>Fecha</label>
        <input id="ovDate" type="date"/>
      </div>
      <div>
        <label>TRM manual (opcional)</label>
        <input id="ovTRM" type="number" step="0.01" min="0" placeholder="auto"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnAddOv" class="primary">+ Agregar overhead</button>
      <span class="muted">Fija <span class="code">trm_used</span> y guarda USD/COP determin√≠stico</span>
    </div>

    <div class="hr"></div>
    <div class="row">
      <div class="muted">Vista tabla Overheads (toggle arriba). Sin recalcular TRM.</div>
    </div>
    <table id="tblOv"><thead><tr>
      <th>Fecha</th><th>Desc</th><th>Cat</th><th>Moneda</th><th>Monto</th><th>TRM usada</th><th>USD fijo</th><th>COP fijo</th>
    </tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- CAT√ÅLOGO -->
<section id="tab-cat" class="tab">
  <div class="panel">
    <div class="row">
      <input id="catName" class="grow" placeholder="Nombre / modelo"/>
      <input id="catBrand" placeholder="Marca"/>
      <input id="catCat" placeholder="Categor√≠a"/>
      <input id="catRef" type="number" step="1" min="0" placeholder="VR COP"/>
      <button id="btnAddCat" class="primary">+ Agregar</button>
    </div>
    <div class="hr"></div>
    <div class="row">
      <input type="file" id="fileCatalog" accept=".xlsx,.xls,.csv"/>
      <button id="btnPreview" class="small">Vista previa</button>
      <button id="btnImport" class="small primary">Importar (‚â•100 en lote)</button>
      <span class="muted">Mapeo: name, ref_cop | opcionales: brand, cat</span>
    </div>
    <div id="previewBox" class="muted" style="margin-top:8px"></div>
    <div class="hr"></div>
    <table id="tblCat"><thead><tr>
      <th>Nombre</th><th>Marca</th><th>Cat</th><th>VR (COP)</th><th>Fuente</th><th>Creado</th>
    </tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- SEM√ÅFORO OCR/ML -->
<section id="tab-sem" class="tab">
  <div class="panel">
    <div class="row">
      <input id="semText" class="grow" placeholder="Pega texto/sku si ya lo tienes‚Ä¶"/>
      <button id="btnCam" class="small">üì∑ C√°mara</button>
      <input id="semFile" type="file" accept="image/*"/>
      <button id="btnOCR" class="primary">Extraer & Buscar ML</button>
    </div>
    <div class="row" style="margin-top:8px">
      <video id="video" autoplay playsinline class="hidden" style="max-height:160px"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <img id="imgPrev" class="img-preview hidden"/>
      <div id="ocrOut" class="muted"></div>
    </div>
    <div class="hr"></div>
    <div id="mlOut" class="panel" style="background:#0f1620"></div>
  </div>
</section>

<!-- INVENTARIO -->
<section id="tab-inv" class="tab">
  <div class="panel">
    <div class="row">
      <input id="invName" class="grow" placeholder="Producto"/>
      <input id="invStore" placeholder="Tienda"/>
      <input id="invUnitUSD" type="number" step="0.01" min="0" placeholder="Costo USD"/>
      <input id="invQty" type="number" step="1" min="1" value="1" placeholder="Qty"/>
      <button id="btnAddInv" class="primary">+ Agregar</button>
    </div>
    <div class="hr"></div>
    <table id="tblInv"><thead><tr>
      <th>Producto</th><th>Tienda</th><th>Qty</th><th>Costo USD</th><th>VSV USD</th><th>Aporte USD</th><th>Margen USD</th>
    </tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- VENTAS -->
<section id="tab-ven" class="tab">
  <div class="panel">
    <div class="row">
      <input id="venName" class="grow" placeholder="Producto vendido"/>
      <input id="venStore" placeholder="Tienda"/>
      <input id="venQty" type="number" step="1" min="1" value="1" placeholder="Qty"/>
      <input id="venUnitUSD" type="number" step="0.01" min="0" placeholder="Costo USD"/>
      <input id="venDate" type="date"/>
      <input id="venTRM" type="number" step="0.01" min="0" placeholder="TRM (auto)"/>
      <input id="venSaleCOP" type="number" step="1" min="0" placeholder="PVP COP"/>
      <button id="btnAddSale" class="primary">+ Registrar venta</button>
    </div>
    <div class="hr"></div>
    <table id="tblVen"><thead><tr>
      <th>Fecha</th><th>Prod</th><th>Qty</th><th>Costo USD</th><th>TRM usada</th><th>Venta COP</th><th>Aporte USD</th><th>Profit USD</th>
    </tr></thead><tbody></tbody></table>
  </div>
</section>

<!-- REPORTES -->
<section id="tab-rep" class="tab">
  <div class="panel grid cols-2">
    <div>
      <div class="muted">Uso de BT (estimado)</div>
      <b id="repUso">‚Äî</b>
      <div class="muted">= (overheads USD + costo inventario USD) / BT</div>
    </div>
    <div>
      <div class="muted">Ejecuci√≥n real</div>
      <b id="repReal">‚Äî</b>
      <div class="muted">= (overheads USD + costo ventas ejecutadas USD) / BT</div>
    </div>
  </div>
</section>

<!-- LIBS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/*** ===========================
 *  CONFIG SUPABASE
 * ============================*/
// TODO: Reemplaza por tus credenciales (proyecto p√∫blico)
const SUPABASE_URL = 'https://YOUR-PROJECT.ref.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

/*** ===========================
 *  ESTADO APP
 * ============================*/
let state = {
  tripId: null,
  viewCurr: 'USD', // vista de tablas y KPIs
  settings: null,  // trip_settings
  trmToday: null,  // cache de TRM hoy para UI
  cacheCatalog: [], cacheOv: [], cacheInv: [], cacheVen: []
};
const $ = sel => document.querySelector(sel);

/*** ===========================
 *  UTILIDADES
 * ============================*/
const fmtUSD = v => (v==null?'‚Äî':`$${Number(v).toFixed(2)} USD`);
const fmtCOP = v => (v==null?'‚Äî':`$${Number(v).toLocaleString('es-CO')} COP`);
const fmtPct = v => (v==null?'‚Äî':`${(100*Number(v)).toFixed(1)}%`);
const todayISO = () => new Date().toISOString().slice(0,10);

async function fetchTRMFromAPI(){
  // open.er-api.com latest USD base; COP rate in data.rates.COP
  try{
    const r = await fetch('https://open.er-api.com/v6/latest/USD',{cache:'no-store'});
    const j = await r.json();
    if(j && j.result === 'success' && j.rates && j.rates.COP){
      return Number(j.rates.COP);
    }
  }catch(e){ console.warn('TRM API error', e); }
  return null;
}

// IQR outlier trimming
function medianIQR(values){
  const arr = values.filter(v=>Number.isFinite(v)).sort((a,b)=>a-b);
  if(arr.length===0) return null;
  const q1 = arr[Math.floor((arr.length/4))];
  const q3 = arr[Math.floor((arr.length*3)/4)];
  const iqr = q3 - q1;
  const lo = q1 - 1.5*iqr, hi = q3 + 1.5*iqr;
  const trimmed = arr.filter(v=>v>=lo && v<=hi);
  const mid = Math.floor(trimmed.length/2);
  if(trimmed.length===0) return null;
  return (trimmed.length%2!==0) ? trimmed[mid] : (trimmed[mid-1]+trimmed[mid])/2;
}

/*** ===========================
 *  TABS / UI
 * ============================*/
document.querySelectorAll('nav.tabs button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    const id = 'tab-'+btn.dataset.tab;
    $('#'+id).classList.add('active');
  });
});
$('#viewUSD').addEventListener('click',()=>{state.viewCurr='USD'; renderAll();});
$('#viewCOP').addEventListener('click',()=>{state.viewCurr='COP'; renderAll();});
$('#btnSync').addEventListener('click',()=>loadAll());
$('#btnTRM').addEventListener('click',async ()=>{
  const t = await fetchTRMFromAPI();
  state.trmToday = t;
  $('#kpiTRM').textContent = t? fmtCOP(t):'‚Äî';
});

/*** ===========================
 *  VIAJES
 * ============================*/
async function loadTrips(){
  const { data, error } = await sb.from('trips').select('*').order('created_at',{ascending:false});
  if(error) { alert('Error cargando viajes: '+error.message); return; }
  const sel = $('#tripSelect');
  sel.innerHTML = '';
  data.forEach(r=>{
    const opt = document.createElement('option');
    opt.value = r.id; opt.textContent = `${r.name} (#${r.id})`;
    sel.appendChild(opt);
  });
  if(data.length && !state.tripId){ state.tripId = data[0].id; }
  if(state.tripId){ sel.value = state.tripId; }
  sel.onchange = ()=>{ state.tripId = Number(sel.value); loadAll(); };
}

async function createTrip(name){
  if(!name) return;
  const { data, error } = await sb.from('trips').insert({name}).select().single();
  if(error){ alert(error.message); return; }
  // crea settings por defecto
  await sb.rpc('upsert_trip_settings', { p_trip_id: data.id, p_bt_usd: 7000, p_gb_pct: 30, p_default_trm: 4200 });
  state.tripId = data.id;
  await loadTrips(); await loadAll();
}
async function duplicateTrip(fromId, name){
  if(!fromId || !name) return;
  const { data: trip, error } = await sb.from('trips').insert({name, notes: `Duplicado de ${fromId}`}).select().single();
  if(error){ alert(error.message); return; }
  const newId = trip.id;
  // dup settings
  const { data: set } = await sb.from('trip_settings').select('*').eq('trip_id', fromId).maybeSingle();
  await sb.rpc('upsert_trip_settings', { p_trip_id: newId, p_bt_usd: set?.bt_usd ?? 7000, p_gb_pct: set?.gb_pct ?? 30, p_default_trm: set?.default_trm ?? 4200 });

  // dup cat√°logo (VR)
  await sb.rpc('upsert_catalog_batch', { p_rows: JSON.stringify(
    (await sb.from('catalog').select('*').eq('trip_id', fromId)).data?.map(r=>({
      trip_id: newId, name: r.name, brand: r.brand, cat: r.cat, ref_cop: r.ref_cop, source: r.source
    })) ?? []
  )});
  state.tripId = newId; await loadTrips(); await loadAll();
}

// UI botones viajes
$('#btnNewTrip').addEventListener('click',()=> {
  const n = prompt('Nombre del viaje (ej: Orlando Nov 7 2025)');
  createTrip(n);
});
$('#btnDupTrip').addEventListener('click',async ()=>{
  const from = state.tripId || Number(prompt('ID de viaje origen'));
  const name = prompt('Nombre del nuevo viaje duplicado');
  if(from && name) await duplicateTrip(from, name);
});

/*** ===========================
 *  SETTINGS (BT, GB, TRM por defecto)
 * ============================*/
async function loadTripSettings(tripId){
  const { data, error } = await sb.from('trip_settings').select('*').eq('trip_id', tripId).maybeSingle();
  if(error){ alert('Error settings: '+error.message); return; }
  state.settings = data || { trip_id: tripId, bt_usd:7000, gb_pct:30, default_trm:4200, updated_at:null };
  $('#inpBT').value = state.settings.bt_usd ?? 7000;
  $('#inpGB').value = state.settings.gb_pct ?? 30;
  $('#inpTRMDef').value = state.settings.default_trm ?? 4200;
  $('#kpiBT').textContent = fmtUSD(state.settings.bt_usd ?? 0);
  $('#kpiUpdated').textContent = 'Actualizado: ' + (state.settings.updated_at ? new Date(state.settings.updated_at).toLocaleString() : '‚Äî');
}
$('#btnSaveCfg').addEventListener('click', async ()=>{
  if(!state.tripId) return;
  const bt = Number($('#inpBT').value), gb = Number($('#inpGB').value), dtrm = Number($('#inpTRMDef').value);
  await sb.rpc('upsert_trip_settings', { p_trip_id: state.tripId, p_bt_usd: bt, p_gb_pct: gb, p_default_trm: dtrm });
  await loadTripSettings(state.tripId);
  await renderAll();
});

/*** ===========================
 *  TRM: ensure en DB (v√≠a RPC)
 * ============================*/
async function ensureTRM(dateISO){
  const d = dateISO || todayISO();
  // intenta TRM de API si no hay override en UI
  let trm = await fetchTRMFromAPI();
  if(!trm) trm = Number($('#inpTRMDef').value || state.settings?.default_trm || 4200);
  const { data, error } = await sb.rpc('ensure_trm', { p_date: d, p_trm: trm });
  if(error){ console.warn('ensure_trm', error); }
  return data ?? trm;
}

/*** ===========================
 *  OVERHEADS
 * ============================*/
async function addOverhead(payload){
  const { trip_id, description, cat, currency, amount, date, trmManual } = payload;
  const trm = trmManual>0 ? trmManual : await ensureTRM(date);
  const { data, error } = await sb.rpc('add_overhead', {
    p_trip_id: trip_id, p_description: description, p_cat: cat,
    p_currency: currency, p_amount: amount, p_date: date, p_trm: trm
  });
  if(error){ alert('Error overhead: '+error.message); return; }
}
$('#btnAddOv').addEventListener('click', async ()=>{
  if(!state.tripId) return;
  const desc=$('#ovDesc').value.trim(), cat=$('#ovCat').value.trim(), cur=$('#ovCur').value;
  const amt=Number($('#ovAmt').value), date=$('#ovDate').value || todayISO();
  const trmManual = Number($('#ovTRM').value);
  if(!amt || amt<=0){ alert('Monto inv√°lido'); return; }
  await addOverhead({trip_id: state.tripId, description:desc, cat, currency:cur, amount:amt, date, trmManual});
  $('#ovDesc').value=''; $('#ovCat').value=''; $('#ovAmt').value=''; $('#ovTRM').value='';
  await loadOverheads(); await renderKPIs(); await renderReportes();
});

async function loadOverheads(){
  const { data, error } = await sb.from('overheads')
    .select('*').eq('trip_id', state.tripId).order('created_at',{ascending:false});
  if(error){ console.warn(error); return; }
  state.cacheOv = data||[];
  renderOverheads();
}
function renderOverheads(){
  const tb = $('#tblOv tbody'); tb.innerHTML='';
  const viewUSD = state.viewCurr==='USD';
  $('#lblVista').textContent = state.viewCurr;
  state.cacheOv.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(r.created_at).toLocaleDateString()}</td>
      <td>${r.description||''}</td>
      <td>${r.cat||''}</td>
      <td>${r.currency}</td>
      <td>${ viewUSD ? fmtUSD(r.currency==='USD'?r.amount_usd:r.amount_usd_fixed)
                     : fmtCOP(r.currency==='COP'?r.amount_cop:r.amount_cop_fixed) }</td>
      <td>${fmtCOP(r.trm_used)}</td>
      <td>${fmtUSD(r.amount_usd_fixed)}</td>
      <td>${fmtCOP(r.amount_cop_fixed)}</td>
    `;
    tb.appendChild(tr);
  });
}

/*** ===========================
 *  CAT√ÅLOGO
 * ============================*/
async function loadCatalog(){
  const { data, error } = await sb.from('catalog').select('*').eq('trip_id', state.tripId).order('created_at',{ascending:false});
  if(error){ console.warn(error); return; }
  state.cacheCatalog = data||[];
  renderCatalog();
}
function renderCatalog(){
  const tb = $('#tblCat tbody'); tb.innerHTML='';
  state.cacheCatalog.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.brand||''}</td><td>${r.cat||''}</td>
      <td>${fmtCOP(r.ref_cop)}</td><td>${r.source||''}</td>
      <td>${new Date(r.created_at).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}
$('#btnAddCat').addEventListener('click', async ()=>{
  const name=$('#catName').value.trim(); if(!name){ alert('Nombre requerido'); return; }
  const ref=Number($('#catRef').value); if(!(ref>0)){ alert('VR COP inv√°lido'); return; }
  const brand=$('#catBrand').value.trim()||''; const cat=$('#catCat').value.trim()||'';
  const row = { trip_id: state.tripId, name, brand, cat, ref_cop: ref, source: 'manual' };
  await sb.rpc('upsert_catalog_batch', { p_rows: JSON.stringify([row]) });
  $('#catName').value=''; $('#catBrand').value=''; $('#catCat').value=''; $('#catRef').value='';
  await loadCatalog();
});

/*** Import Excel/CSV ***/
let parsedCatalog = [];
$('#btnPreview').addEventListener('click', async ()=>{
  const f = $('#fileCatalog').files?.[0];
  if(!f){ alert('Selecciona un archivo'); return; }
  const data = await f.arrayBuffer();
  const wb = XLSX.read(data, { type:'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true });
  parsedCatalog = json.map(r=>({
    trip_id: state.tripId,
    name: String(r.name || r.Nombre || r.NOMBRE || '').trim(),
    brand: String(r.brand || r.Marca || '').trim(),
    cat: String(r.cat || r.Categoria || r.category || '').trim(),
    ref_cop: Number(r.ref_cop || r.VR || r.VR_COP || 0),
    source: 'manual'
  }));
  // validaci√≥n
  const errs = [];
  const ok = parsedCatalog.filter((r,i)=>{
    const valid = r.name && r.ref_cop>0;
    if(!valid) errs.push(`Fila ${i+2}: name/ref_cop inv√°lidos`);
    return valid;
  });
  const prev = ok.slice(0,50).map(r=>`${r.name} | ${r.brand} | ${r.cat} | ${r.ref_cop}`).join('<br>');
  $('#previewBox').innerHTML = `<b>Preview (50):</b><br>${prev || '‚Äî'}<div class="warn">${errs.length?errs.length+' errores':''}</div>`;
});
$('#btnImport').addEventListener('click', async ()=>{
  if(parsedCatalog.length<1){ alert('Primero vista previa'); return; }
  await sb.rpc('upsert_catalog_batch', { p_rows: JSON.stringify(parsedCatalog) });
  parsedCatalog = [];
  $('#previewBox').innerHTML = '<span class="ok">Importado.</span>';
  await loadCatalog();
});

/*** ===========================
 *  SEM√ÅFORO: OCR + MercadoLibre
 * ============================*/
let stream;
$('#btnCam').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:true});
    const v = $('#video'); v.srcObject = stream; v.classList.remove('hidden');
  }catch(e){ alert('C√°mara no disponible'); }
});
$('#btnOCR').addEventListener('click', async ()=>{
  const file = $('#semFile').files?.[0];
  let text = ($('#semText').value||'').trim();
  if(!text && (stream || file)){
    // captura de frame o file
    if(stream){
      const v=$('#video'), c=$('#canvas'); c.width=v.videoWidth; c.height=v.videoHeight;
      const ctx = c.getContext('2d'); ctx.drawImage(v,0,0); const blob = await new Promise(res=>c.toBlob(res,'image/png'));
      text = await ocrBlob(blob);
    } else if(file){
      $('#imgPrev').classList.remove('hidden'); $('#imgPrev').src = URL.createObjectURL(file);
      text = await ocrBlob(file);
    }
  }
  if(!text){ alert('Sin texto/imagen.'); return; }
  $('#ocrOut').innerHTML = `<b>OCR/Texto:</b> <span class="muted">${text.slice(0,220)}‚Ä¶</span>`;
  const vr = await fetchMLandCompute(text);
  renderMLResult(vr);
});
async function ocrBlob(blob){
  try{
    const worker = await Tesseract.createWorker('spa','eng'); // eng+spa
    const { data } = await worker.recognize(blob);
    await worker.terminate();
    return (data?.text || '').replace(/\s+/g,' ').trim();
  }catch(e){ console.warn(e); return ''; }
}
async function fetchMLandCompute(query){
  // Heur√≠stica simple: limpia y reduce
  const q = encodeURIComponent(query.slice(0,120));
  const url = `https://api.mercadolibre.com/sites/MCO/search?q=${q}`;
  const r = await fetch(url); const j = await r.json();
  const prices = (j.results||[]).map(x=>Number(x.price)).filter(x=>x>0);
  const med = medianIQR(prices);
  return { query, count: prices.length, median: med, sample: prices.slice(0,10) };
}
function renderMLResult(v){
  if(!v){ $('#mlOut').innerHTML = '<span class="danger">Sin resultados.</span>'; return; }
  const html = `
    <div class="row"><div class="grow">
      <div class="muted">Resultados ML: <b>${v.count}</b></div>
      <div>VR propuesto (p50/IQR): <b>${v.median?fmtCOP(v.median):'‚Äî'}</b></div>
      <div class="muted">Muestra: ${v.sample.map(x=>fmtCOP(x)).join(' ¬∑ ')}</div>
    </div>
    <div>
      <input id="mlName" placeholder="Nombre cat√°logo"/>
      <input id="mlBrand" placeholder="Marca (opcional)"/>
      <input id="mlCat" placeholder="Cat (opcional)"/>
      <button id="btnSaveVR" class="primary">Guardar en cat√°logo</button>
    </div></div>`;
  $('#mlOut').innerHTML = html;
  $('#btnSaveVR').onclick = async ()=>{
    const name = $('#mlName').value.trim(); if(!name){ alert('Nombre requerido'); return; }
    const brand = $('#mlBrand').value.trim(); const cat = $('#mlCat').value.trim();
    const row = { trip_id: state.tripId, name, brand, cat, ref_cop: v.median||0, source:'ML' };
    await sb.rpc('upsert_catalog_batch', { p_rows: JSON.stringify([row]) });
    await loadCatalog();
    alert('Guardado en cat√°logo.');
  };
}

/*** ===========================
 *  INVENTARIO
 * ============================*/
async function loadInv(){
  const { data, error } = await sb.from('products').select('*').eq('trip_id', state.tripId).order('created_at',{ascending:false});
  if(error){ console.warn(error); return; }
  state.cacheInv = data||[];
  renderInv();
}
function computeROSync(){
  // rO = sum(overheads.usd_fixed)/BT
  const bt = Number(state.settings?.bt_usd || 0) || 0;
  const sumOv = (state.cacheOv||[]).reduce((a,r)=>a+Number(r.amount_usd_fixed||0),0);
  return bt>0 ? (sumOv / bt) : 0;
}
function deriveEstimates(p){
  const gb = Number(state.settings?.gb_pct||0)/100;
  const rO = computeROSync();
  const vsv = Number(p.unit_usd)*(1 + gb + rO);
  const aporte = Number(p.unit_usd)*rO;
  const margen = vsv - Number(p.unit_usd) - aporte;
  return { vsv, aporte, margen };
}
function renderInv(){
  const tb = $('#tblInv tbody'); tb.innerHTML='';
  state.cacheInv.forEach(r=>{
    const { vsv, aporte, margen } = deriveEstimates(r);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.store||''}</td><td>${r.qty}</td>
      <td>${fmtUSD(r.unit_usd)}</td><td>${fmtUSD(vsv)}</td>
      <td>${fmtUSD(aporte)}</td><td>${fmtUSD(margen)}</td>`;
    tb.appendChild(tr);
  });
  // KPI compras acumuladas (USD)
  const sumUSD = (state.cacheInv||[]).reduce((a,r)=>a + Number(r.unit_usd||0)*Number(r.qty||1), 0);
  $('#kpiCompras').textContent = state.viewCurr==='USD' ? fmtUSD(sumUSD) : fmtCOP(sumUSD * (state.settings?.default_trm||4200));
}
$('#btnAddInv').addEventListener('click', async ()=>{
  const name=$('#invName').value.trim(); if(!name) return alert('Nombre');
  const store=$('#invStore').value.trim(); const unit=Number($('#invUnitUSD').value); if(!(unit>=0)) return alert('USD inv√°lido');
  const qty=Number($('#invQty').value||1);
  const { vsv, aporte, margen } = deriveEstimates({unit_usd:unit});
  const row = { trip_id: state.tripId, name, store, unit_usd: unit, qty,
    est_sell_usd: vsv, est_aporte_usd: aporte, est_margin_usd: margen };
  const { error } = await sb.from('products').insert(row);
  if(error){ alert(error.message); return; }
  $('#invName').value=''; $('#invStore').value=''; $('#invUnitUSD').value=''; $('#invQty').value=1;
  await loadInv(); await renderKPIs(); await renderReportes();
});

/*** ===========================
 *  VENTAS
 * ============================*/
async function loadSales(){
  const { data, error } = await sb.from('sales').select('*').eq('trip_id', state.tripId).order('created_at',{ascending:false});
  if(error){ console.warn(error); return; }
  state.cacheVen = data||[];
  renderSales();
}
function renderSales(){
  const tb = $('#tblVen tbody'); tb.innerHTML='';
  state.cacheVen.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date(r.created_at).toLocaleDateString()}</td>
      <td>${r.product_name||''}</td><td>${r.qty}</td>
      <td>${fmtUSD(r.unit_usd)}</td><td>${fmtCOP(r.trm_used)}</td>
      <td>${fmtCOP(r.sale_cop)}</td><td>${fmtUSD(r.aporte_usd)}</td><td>${fmtUSD(r.profit_usd)}</td>`;
    tb.appendChild(tr);
  });
}
$('#btnAddSale').addEventListener('click', async ()=>{
  const name=$('#venName').value.trim(); if(!name) return alert('Producto');
  const store=$('#venStore').value.trim(); const qty=Number($('#venQty').value||1);
  const unit=Number($('#venUnitUSD').value||0);
  const date=$('#venDate').value || todayISO();
  let trm = Number($('#venTRM').value||0); if(!(trm>0)) trm = await ensureTRM(date);
  const saleCOP=Number($('#venSaleCOP').value||0);
  // costo ventas ejecutadas (USD) = unit_usd * qty
  const aporteUSD = computeROSync()*unit*qty;
  const profitUSD = (saleCOP/trm) - (unit*qty) - aporteUSD;
  const row = { trip_id: state.tripId, product_name:name, store, qty, unit_usd:unit,
                trm_used: trm, sale_cop: saleCOP, aporte_usd: aporteUSD, profit_usd: profitUSD };
  const { error } = await sb.from('sales').insert(row);
  if(error){ alert(error.message); return; }
  ['venName','venStore','venQty','venUnitUSD','venTRM','venSaleCOP'].forEach(id=>$('#'+id).value='');
  await loadSales(); await renderReportes();
});

/*** ===========================
 *  KPI & REPORTES
 * ============================*/
async function renderKPIs(){
  $('#kpiBT').textContent = fmtUSD(state.settings?.bt_usd);
  const sumOvUSD = (state.cacheOv||[]).reduce((a,r)=>a+Number(r.amount_usd_fixed||0),0);
  $('#kpiOV').textContent = state.viewCurr==='USD' ? fmtUSD(sumOvUSD) : fmtCOP(sumOvUSD * (state.settings?.default_trm||4200));
  const rO = computeROSync();
  $('#kpiRO').textContent = fmtPct(rO);
  $('#lblVista').textContent = state.viewCurr;
}
function sumInvUSD(){ return (state.cacheInv||[]).reduce((a,r)=>a+Number(r.unit_usd||0)*Number(r.qty||1),0); }
function sumSalesCostUSD(){ return (state.cacheVen||[]).reduce((a,r)=>a+Number(r.unit_usd||0)*Number(r.qty||1),0); }

async function renderReportes(){
  const bt = Number(state.settings?.bt_usd||0);
  const ovUSD = (state.cacheOv||[]).reduce((a,r)=>a+Number(r.amount_usd_fixed||0),0);
  const invUSD = sumInvUSD();
  const realCostUSD = ovUSD + sumSalesCostUSD();
  const uso = bt>0 ? (ovUSD + invUSD)/bt : 0;
  const ejec = bt>0 ? realCostUSD/bt : 0;

  const toMoney = (v)=> state.viewCurr==='USD' ? fmtUSD(v) : fmtCOP(v*(state.settings?.default_trm||4200));
  $('#repUso').innerHTML = `${toMoney(ovUSD)} + ${toMoney(invUSD)} ‚áí <b>${(100*uso).toFixed(1)}%</b>`;
  $('#repReal').innerHTML = `${toMoney(ovUSD)} + ${toMoney(sumSalesCostUSD())} ‚áí <b>${(100*ejec).toFixed(1)}%</b>`;
}

function renderAll(){ renderOverheads(); renderInv(); renderKPIs(); renderReportes(); }

/*** ===========================
 *  LOAD ALL
 * ============================*/
async function loadAll(){
  if(!state.tripId) return;
  await loadTripSettings(state.tripId);
  await Promise.all([loadOverheads(), loadCatalog(), loadInv(), loadSales()]);
  if(state.trmToday==null){ state.trmToday = await fetchTRMFromAPI(); }
  $('#kpiTRM').textContent = state.trmToday? fmtCOP(state.trmToday):'‚Äî';
  renderAll();
}

/*** ===========================
 *  INIT
 * ============================*/
(async function init(){
  // si no hay viajes, creamos uno de ejemplo
  await loadTrips();
  if(!state.tripId){
    await createTrip('Orlando Nov 7 2025');
  } else {
    await loadAll();
  }
})();

</script>

</body>
</html>
