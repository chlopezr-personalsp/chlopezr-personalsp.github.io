<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personal Shopper USA</title>

<!-- Favicon minimal (base64) -->
<link rel="icon" type="image/svg+xml"
href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%231a2a3a'/%3E%3Cpath d='M74 84h62c22 0 40 18 40 40s-18 40-40 40H106v24H74V84Zm32 56h30c7 0 12-5 12-12s-5-12-12-12h-30v24Z' fill='%2360a5fa'/%3E%3C/svg%3E" />

<style>
:root{
  --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
  --brand:#60a5fa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:#334155;
}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu;
  background:linear-gradient(120deg,#0a0f1a,#101726,#0d1422); color:var(--text)}
.wrap{max-width:1200px;margin:0 auto;padding:14px}
.header{display:flex;align-items:center;gap:10px;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(145deg,#60a5fa,#22d3ee);
  display:inline-flex;align-items:center;justify-content:center;color:#0b1220;font-weight:900}
.card{background:rgba(255,255,255,.04);border:1px solid #1f2937;border-radius:14px;padding:12px}
.k{color:var(--muted);font-size:12px}
.v{font-size:20px;font-weight:700}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:900px){.row{grid-template-columns:1fr}}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:900px){.grid4{grid-template-columns:1fr 1fr}}
@media(max-width:580px){.grid4{grid-template-columns:1fr}}
.btn{display:inline-flex;align-items:center;gap:6px;background:#0f172a;color:var(--text);
  border:1px solid #334155;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}
.btn:hover{background:#111827} .btn:disabled{opacity:.55;cursor:not-allowed}
.btn.primary{background:#1d4ed8;border-color:#1d4ed8}
.toolbar{display:flex;gap:6px;flex-wrap:wrap}
.input, select{width:100%;background:#0b1220;color:var(--text);border:1px solid #334155;
  border-radius:10px;padding:8px;font-size:14px}
label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
.tabs{display:flex;gap:6px;margin:10px 0}
.tab{padding:6px 10px;border:1px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:13px}
.tab.active{background:#1f2937;border-color:#475569}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left}
thead th{position:sticky;top:0;background:#0b1220;z-index:1}
.right{text-align:right}
.muted{color:var(--muted)}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #334155;border-radius:999px;padding:2px 8px}
.chip.ok{background:rgba(16,185,129,.12);border-color:#065f46}
.chip.warn{background:rgba(245,158,11,.12);border-color:#78350f}
.chip.bad{background:rgba(239,68,68,.12);border-color:#7f1d1d}
.progress{height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,#22d3ee,#60a5fa);width:0%}
.small{font-size:11px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header card">
    <div class="brand">
      <div class="logo">PS</div>
      <div>
        <div style="font-weight:800;font-size:18px">Personal Shopper USA</div>
        <div class="muted small">Viajes, costos, inventario, m√°rgenes</div>
      </div>
    </div>
    <div class="toolbar">
      <select id="tripSel" class="input" style="max-width:280px"></select>
      <button id="newTrip" class="btn">Ôºã Nuevo viaje</button>
      <button id="dupTrip" class="btn">‚éò Duplicar</button>
      <button id="btnSync" class="btn">‚ü≥ Sync</button>
      <button id="btnTRM" class="btn">‚áÖ TRM</button>
      <button id="btnTRMmanual" class="btn">‚úç TRM</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid4" style="margin-top:10px">
    <div class="card"><div class="k">BT (presupuesto estimado)</div><div class="v" id="kBT">$‚Äî</div></div>
    <div class="card"><div class="k">Overheads (USD fijos)</div><div class="v" id="kV">$‚Äî</div></div>
    <div class="card"><div class="k">rO = V / BT</div><div class="v" id="kRO">‚Äî</div></div>
    <div class="card"><div class="k">TRM UI (por defecto)</div><div class="v" id="kTRM">‚Äî</div></div>
  </div>

  <!-- Navegaci√≥n -->
  <div class="tabs">
    <div class="tab active" data-tab="config">‚öôÔ∏è Configuraci√≥n</div>
    <div class="tab" data-tab="catalog">üìö Cat√°logo</div>
    <div class="tab" data-tab="semaforo">üö¶ Sem√°foro</div>
    <div class="tab" data-tab="invent">üì¶ Inventario</div>
    <div class="tab" data-tab="ventas">üíµ Ventas</div>
    <div class="tab" data-tab="report">üìä Reportes</div>
  </div>

  <!-- CONFIG -->
  <div id="panel-config" class="card">
    <div class="row">
      <div>
        <label>BT (USD) ‚Äì presupuesto</label>
        <input id="inpBT" class="input" type="number" step="0.01" value="7000">
      </div>
      <div>
        <label>Margen objetivo (GB%)</label>
        <input id="inpGB" class="input" type="number" step="1" value="30">
      </div>
      <div>
        <label>TRM por defecto (se usa si no hay TRM diaria)</label>
        <input id="inpTRM" class="input" type="number" step="1" value="4000">
      </div>
      <div style="display:flex;align-items:flex-end;gap:6px">
        <button id="saveSettings" class="btn primary">üíæ Guardar settings</button>
        <span class="small muted" id="settingsStamp">‚Äî</span>
      </div>
    </div>

    <hr style="border-color:#1f2937;margin:14px 0">

    <div class="row">
      <div>
        <div class="k" style="margin-bottom:6px">Agregar costo del viaje</div>
        <label>Descripci√≥n</label>
        <input id="ohDesc" class="input" placeholder="Tiquetes, hospedaje, env√≠os‚Ä¶">
        <label>Categor√≠a</label>
        <select id="ohCat" class="input"></select>
        <label>Moneda</label>
        <select id="ohCur" class="input">
          <option value="USD">USD</option>
          <option value="COP">COP</option>
        </select>
        <label>Monto</label>
        <input id="ohAmt" class="input" type="number" step="0.01">
        <label>Fecha</label>
        <input id="ohDate" class="input" type="date">
        <button id="ohAdd" class="btn" style="margin-top:8px">Ôºã Agregar costo</button>
      </div>
      <div>
        <div class="k">Vista de costos</div>
        <div style="margin:6px 0">
          <button id="viewUSD" class="btn">USD</button>
          <button id="viewCOP" class="btn">COP</button>
          <button id="dlOH" class="btn">‚¨á Exportar (CSV)</button>
        </div>
        <div style="max-height:280px;overflow:auto">
          <table>
            <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Cat</th><th>Moneda</th><th class="right">Monto</th><th>TRM</th><th></th></tr></thead>
            <tbody id="ohT"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CATALOGO -->
  <div id="panel-catalog" class="card" style="display:none">
    <div class="row">
      <div>
        <div class="k">Nueva referencia (VR en COP)</div>
        <label>Producto</label><input id="catName" class="input" placeholder="Ej: Nike Air Max 90">
        <label>Marca</label><input id="catBrand" class="input" placeholder="Nike, Apple‚Ä¶">
        <label>Categor√≠a</label><select id="catCat" class="input"></select>
        <label>Precio ref. COP</label><input id="catCOP" class="input" type="number" step="100">
        <button id="catAdd" class="btn" style="margin-top:8px">Ôºã Agregar</button>
      </div>
      <div>
        <div class="k">Carga masiva</div>
        <input id="fileRef" type="file" accept=".xlsx,.xls,.csv" class="input">
        <div style="margin-top:6px">
          <button id="impRef" class="btn">‚¨Ü Importar</button>
          <button id="tplRef" class="btn">‚¨á Descargar plantilla</button>
          <button id="dlRef" class="btn">‚¨á Exportar (CSV)</button>
        </div>
        <div style="max-height:300px;overflow:auto;margin-top:8px">
          <table>
            <thead><tr><th>Fecha</th><th>Producto</th><th>Marca/Cat</th><th class="right">COP</th><th></th></tr></thead>
            <tbody id="catT"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- SEMAFORO -->
  <div id="panel-semaforo" class="card" style="display:none">
    <div class="row">
      <div>
        <label>Descripci√≥n</label><input id="svName" class="input">
        <label>Categor√≠a</label><select id="svCat" class="input"></select>
        <label>Costo unidad (USD)</label><input id="svUSD" class="input" type="number" step="0.01">
        <label>Cantidad</label><input id="svQty" class="input" type="number" step="1" value="1">
        <label>Tienda</label><input id="svStore" class="input" placeholder="Nike Outlet‚Ä¶">
        <label>Precio venta estimado (COP)</label><input id="svSell" class="input" type="number" step="100">
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
          <button id="svCalc" class="btn primary">Calcular sem√°foro</button>
          <button id="svAdd" class="btn">Ôºã Agregar a inventario</button>
        </div>
      </div>
      <div>
        <div class="k">Resultado</div>
        <div style="margin-top:6px">
          <div>VSV USD: <b id="rVsvUSD">‚Äî</b> | COP: <b id="rVsvCOP">‚Äî</b></div>
          <div>VR COP: <b id="rVrCOP">‚Äî</b> <span class="small muted" id="rSrc"></span></div>
          <div style="margin-top:6px">VSV/VR: <span id="rRatio" class="chip">‚Äî</span> <span id="rExplain" class="small muted"></span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- INVENTARIO -->
  <div id="panel-invent" class="card" style="display:none">
    <div class="k">Inventario del viaje</div>
    <div class="progress" style="margin-top:6px"><div id="invProg"></div></div>
    <div class="small muted" id="invProgText" style="margin-top:6px">‚Äî</div>
    <div style="margin-top:8px">
      <table>
        <thead><tr>
          <th>Fecha</th><th>Producto</th><th>Tienda</th><th>Cat</th>
          <th class="right">Costo USD √ó Qty</th><th class="right">PVP est. COP</th><th class="right">Aporte USD</th><th class="right">Margen USD</th><th></th>
        </tr></thead>
        <tbody id="invT"></tbody>
      </table>
    </div>
  </div>

  <!-- VENTAS -->
  <div id="panel-ventas" class="card" style="display:none">
    <div class="row">
      <div>
        <label>Producto (del inventario)</label><select id="saleSel" class="input"></select>
        <label>Cantidad</label><input id="saleQty" class="input" type="number" step="1" value="1">
        <label>Precio venta (COP)</label><input id="saleCOP" class="input" type="number" step="100">
        <button id="saleAdd" class="btn" style="margin-top:8px">üíæ Guardar venta</button>
      </div>
      <div>
        <div class="k">Ventas</div>
        <div style="max-height:300px;overflow:auto">
          <table>
            <thead><tr><th>Fecha</th><th>Producto</th><th>Tienda</th><th class="right">Qty</th><th class="right">PVP COP</th><th class="right">Aporte USD</th><th class="right">Utilidad USD</th><th></th></tr></thead>
            <tbody id="saleT"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORTES -->
  <div id="panel-report" class="card" style="display:none">
    <div class="row">
      <div class="card">
        <div class="k">Estimado (inventario)</div>
        <div id="repEst">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Real (ventas)</div>
        <div id="repReal">‚Äî</div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="dlEst" class="btn">‚¨á Descargar estimado (CSV)</button>
      <button id="dlReal" class="btn">‚¨á Descargar real (CSV)</button>
    </div>
  </div>
</div>

<!-- LIBRER√çAS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===================== CONFIG B√ÅSICA ===================== */
const SUPABASE_URL = "https://ucrkhrehdedmubykzfzs.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmtocmVoZGVkbXVieWt6ZnpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTc5MzgsImV4cCI6MjA3NzE3MzkzOH0.7CXUuyAPQlm_9RIKbaO9y8Kwjh9c6M7UJcu4xAIM7WA";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// categor√≠as est√°ndar
const CATS = ["Calzado","Accesorios","Electr√≥nica","Ropa","Hogar","Belleza","Deportes","Jugueter√≠a","Otros"];
/* ========================================================= */

let trips = [];     // [{id,title,bt,gb,trm_default}]
let tripId = null;
let settings = {bt:7000, gb:30, trm_default:4000};
let overheads = []; // {id,desc,cat,currency,amount_usd,amount_cop,trm_at,date}
let catalog = [];   // {id,name,brand,cat,ref_cop}
let inventory = []; // products
let sales = [];     // sales

// helpers
const $ = s => document.querySelector(s);
const fmtUSD = n => "$"+(Number(n||0)).toFixed(2);
const fmtCOP = n => "$"+(Math.round(Number(n||0))).toLocaleString("es-CO");

// dropdown categor√≠as
function fillCatSelects(){
  for(const id of ["ohCat","catCat","svCat"]){
    const el = $("#"+id); el.innerHTML = "";
    CATS.forEach(c => { const o=document.createElement('option'); o.textContent=c; o.value=c; el.appendChild(o); });
  }
}

/* ===================== TABS ===================== */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab=t.dataset.tab;
    ["config","catalog","semaforo","invent","ventas","report"].forEach(id=>{
      $("#panel-"+id).style.display = (id===tab?"block":"none");
    });
    if(tab==="ventas") fillSalesSel();
    if(tab==="invent") renderInventory();
    if(tab==="report") renderReports();
  };
});

/* ===================== TRIPS ===================== */
async function loadTrips(){
  // si no existe tabla trips, el select fallar√° silenciosamente y crearemos una por defecto
  const { data } = await supa.from('trips').select('*').order('created_at',{ascending:false});
  trips = data || [];

  if(!trips.length){
    const def = { title: "Orlando ‚Äì Nov 7 2025", bt:7000, gb:30, trm_default:3950 };
    const { data:ins } = await supa.from('trips').insert(def).select();
    trips = ins || [];
  }
  const sel = $("#tripSel"); sel.innerHTML="";
  trips.forEach(t=>{
    const o=document.createElement('option');
    o.value=t.id; o.textContent=t.title;
    sel.appendChild(o);
  });
  tripId = trips[0].id;
  sel.value = tripId;
  sel.onchange = ()=>{ tripId = sel.value; syncAll(); }
}
$("#newTrip").onclick = async ()=>{
  const title = prompt("Nombre del viaje:", "Orlando ‚Äì Nov 7 2025");
  if(!title) return;
  const { data } = await supa.from('trips').insert({title, bt:7000, gb:30, trm_default:3950}).select();
  if(data && data.length){ trips.unshift(data[0]); tripId = data[0].id; }
  await loadTrips(); await syncAll();
};
$("#dupTrip").onclick = async ()=>{
  const t = trips.find(x=>String(x.id)===String(tripId));
  if(!t) return;
  const { data } = await supa.from('trips').insert({title:t.title+" (copy)", bt:t.bt, gb:t.gb, trm_default:t.trm_default}).select();
  if(data && data.length){ trips.unshift(data[0]); tripId = data[0].id; }
  await loadTrips(); await syncAll();
};

/* ===================== SETTINGS (BT/GB/TRM) ===================== */
async function loadSettings(){
  // usamos los campos de trips como settings
  const { data } = await supa.from('trips').select('*').eq('id', tripId).single();
  const t = data || {};
  settings.bt = Number(t.bt||7000);
  settings.gb = Number(t.gb||30);
  settings.trm_default = Number(t.trm_default||4000);

  $("#inpBT").value = settings.bt;
  $("#inpGB").value = settings.gb;
  $("#inpTRM").value = settings.trm_default;
  $("#settingsStamp").textContent = "Cargado " + new Date().toLocaleString('es-CO');
  renderKPIs();
}
$("#saveSettings").onclick = async ()=>{
  const bt = Number($("#inpBT").value||0);
  const gb = Number($("#inpGB").value||0);
  const trm = Number($("#inpTRM").value||0);
  await supa.from('trips').update({bt,gb,trm_default:trm}).eq('id', tripId);
  await loadSettings(); // vuelve a pintar y NO borra nada
};

/* ===================== OVERHEADS ===================== */
async function loadOverheads(){
  const { data } = await supa.from('overheads').select('*').eq('trip_id', tripId).order('created_at',{ascending:false});
  overheads = data || [];
  renderOverheads();
  renderKPIs();
}
function renderOverheads(){
  const tb=$("#ohT"); tb.innerHTML="";
  overheads.forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${o.date? new Date(o.date).toLocaleDateString('es-CO'):'‚Äî'}</td>
      <td>${o.description||''}</td>
      <td>${o.cat||''}</td>
      <td>${o.currency||'USD'}</td>
      <td class="right">${o.currency==='USD'? fmtUSD(o.amount_usd||0): fmtCOP(o.amount_cop||0)}</td>
      <td>${o.trm_at? Math.round(o.trm_at).toLocaleString('es-CO'): '‚Äî'}</td>
      <td><button class="btn" data-del="${o.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=async ()=>{ await supa.from('overheads').delete().eq('id', b.dataset.del); loadOverheads(); }
  });
}
$("#ohAdd").onclick = async ()=>{
  const desc = $("#ohDesc").value.trim();
  const cat  = $("#ohCat").value;
  const cur  = $("#ohCur").value;
  const amt  = Number($("#ohAmt").value||0);
  const date = $("#ohDate").value || new Date().toISOString().slice(0,10);

  if(!desc || !amt){ alert("Completa descripci√≥n y monto"); return; }
  let row = { trip_id:tripId, description:desc, cat, currency:cur, date };

  if(cur==="USD"){ row.amount_usd = amt; row.amount_cop = Math.round(amt * settings.trm_default); row.trm_at = settings.trm_default; }
  else{ row.amount_cop = Math.round(amt); row.amount_usd = (amt / settings.trm_default); row.trm_at = settings.trm_default; }

  await supa.from('overheads').insert(row);
  $("#ohDesc").value=""; $("#ohAmt").value=""; $("#ohDate").value="";
  await loadOverheads();
};
$("#viewUSD").onclick=()=>{ // solo cambia render
  const tb=$("#ohT"); tb.querySelectorAll('tr').forEach((tr,i)=>{
    const o=overheads[i]; if(!o) return;
    tr.children[3].innerText="USD";
    tr.children[4].innerText=fmtUSD(o.amount_usd||0);
  });
};
$("#viewCOP").onclick=()=>{ 
  const tb=$("#ohT"); tb.querySelectorAll('tr').forEach((tr,i)=>{
    const o=overheads[i]; if(!o) return;
    tr.children[3].innerText="COP";
    tr.children[4].innerText=fmtCOP(o.amount_cop||0);
  });
};
$("#dlOH").onclick=()=>downloadCSV(overheads.map(o=>({
  fecha:o.date, descripcion:o.description, categoria:o.cat, moneda:o.currency,
  monto_usd:o.amount_usd, monto_cop:o.amount_cop, trm:o.trm_at
})),"overheads.csv");

/* ===================== CATALOGO ===================== */
async function loadCatalog(){
  const { data } = await supa.from('catalog').select('*').eq('trip_id', tripId).order('created_at',{ascending:false});
  catalog = data || [];
  renderCatalog();
}
function renderCatalog(){
  const tb=$("#catT"); tb.innerHTML="";
  catalog.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${c.created_at? new Date(c.created_at).toLocaleString('es-CO'):'‚Äî'}</td>
      <td>${c.name||''}</td>
      <td>${(c.brand||'')}${c.cat?(' / '+c.cat):''}</td>
      <td class="right">${fmtCOP(c.ref_cop||0)}</td>
      <td><button class="btn" data-del="${c.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=async ()=>{ await supa.from('catalog').delete().eq('id', b.dataset.del); loadCatalog(); }
  });
}
$("#catAdd").onclick = async ()=>{
  const name=$("#catName").value.trim();
  const brand=$("#catBrand").value.trim();
  const cat=$("#catCat").value;
  const cop=Number($("#catCOP").value||0);
  if(!name||!cop){ alert("Producto y COP obligatorios"); return; }
  await supa.from('catalog').insert({trip_id:tripId,name,brand,cat,ref_cop:cop});
  $("#catName").value=""; $("#catBrand").value=""; $("#catCOP").value="";
  await loadCatalog();
};
// plantilla base (xlsx simple con encabezados)
$("#tplRef").onclick=()=>{
  const ws = XLSX.utils.aoa_to_sheet([["name","brand","cat","ref_cop"]]);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "catalog_template");
  XLSX.writeFile(wb,"catalog_template.xlsx");
};
$("#impRef").onclick=async ()=>{
  const f = $("#fileRef").files[0];
  if(!f){ alert("Selecciona archivo"); return; }
  const buf = await f.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws,{defval:""});
  // normaliza y sube
  const batch = rows
    .map(r=>({
      trip_id: tripId,
      name: (r.name||r.product||"").toString().trim(),
      brand:(r.brand||"").toString().trim(),
      cat:  (r.cat||"Otros").toString().trim(),
      ref_cop: Number(r.ref_cop||r.cop||0)
    }))
    .filter(r=>r.name && r.ref_cop>0);
  if(!batch.length){ alert("No hay filas v√°lidas"); return; }
  await supa.from('catalog').insert(batch);
  await loadCatalog();
};
$("#dlRef").onclick=()=>downloadCSV(catalog,"catalog.csv");

/* ===================== SEM√ÅFORO ===================== */
function aportePorDolar(){
  const vUSD = overheads.reduce((s,o)=> s + Number(o.amount_usd||0), 0);
  return settings.bt>0 ? (vUSD / settings.bt) : 0;
}
function VSV_USD(unitUSD){ return Number(unitUSD) * (1 + settings.gb/100 + aportePorDolar()); }
async function buscarVR(descr, cat){
  // 1) cat√°logo local (por palabras + categor√≠a)
  const q = (descr||"").toLowerCase();
  let best=null,scoreBest=0;
  catalog.forEach(c=>{
    const t=((c.name||"")+" "+(c.brand||"")+" "+(c.cat||"")).toLowerCase();
    const ws=q.split(/\s+/).filter(w=>w.length>2);
    let score=0; ws.forEach(w=>{ if(t.includes(w)) score++; });
    if(cat && c.cat===cat) score+=1;
    if(score>scoreBest){scoreBest=score; best=c;}
  });
  let vr=null, src="‚Äî";
  if(best){ vr = Number(best.ref_cop||0); src = "Cat√°logo"; }

  // 2) si no hay en cat√°logo, intenta MercadoLibre por texto (simple)
  if(!vr){
    try{
      const r = await fetch("https://api.mercadolibre.com/sites/MCO/search?q="+encodeURIComponent(descr)+"&limit=5");
      const j = await r.json();
      if(j && j.results && j.results.length){
        const precios = j.results.map(x=>x.price).filter(n=>n>0);
        if(precios.length){ vr = Math.round(precios.reduce((a,b)=>a+b,0)/precios.length); src="MercadoLibre"; }
      }
    }catch(e){}
  }
  return {vr,src};
}
$("#svCalc").onclick = async ()=>{
  const name=$("#svName").value.trim();
  const cat=$("#svCat").value;
  const unit=Number($("#svUSD").value||0);
  if(!name||unit<=0){ alert("Completa descripci√≥n y costo"); return; }
  const vsvUSD = VSV_USD(unit);
  const vsvCOP = vsvUSD*settings.trm_default;

  const {vr,src} = await buscarVR(name,cat);
  $("#rVsvUSD").textContent = fmtUSD(vsvUSD);
  $("#rVsvCOP").textContent = fmtCOP(vsvCOP);
  $("#rVrCOP").textContent  = vr? fmtCOP(vr): "‚Äî";
  $("#rSrc").textContent    = src==="‚Äî" ? "(sin referencia)" : `(fuente: ${src})`;

  const chip=$("#rRatio"); chip.className="chip"; let explain="Sin referencia";
  if(vr){
    const ratio = vsvCOP/vr; chip.textContent = ratio.toFixed(2);
    if(ratio<0.85){ chip.classList.add("ok"); explain="Verde (competitivo)"; }
    else if(ratio<=0.95){ chip.classList.add("warn"); explain="Amarillo (ajustar)"; }
    else{ chip.classList.add("bad"); explain="Rojo (no viable)"; }
  }else chip.textContent="‚Äî";
  $("#rExplain").textContent=explain;
};
$("#svAdd").onclick = async ()=>{
  const name=$("#svName").value.trim();
  const cat=$("#svCat").value;
  const unit=Number($("#svUSD").value||0);
  const qty =Number($("#svQty").value||0);
  const store=$("#svStore").value.trim();
  const estCOP=Number($("#svSell").value||0);
  if(!name||!unit||!qty||!store||!estCOP){ alert("Completa todos los campos"); return; }
  const apUSDunit = unit*aportePorDolar();
  const estUSD = estCOP/settings.trm_default;
  const mgUSD = estUSD - unit - apUSDunit;
  await supa.from('products').insert({
    trip_id:tripId,name,cat,store,unit_usd:unit,qty,
    est_sell_cop:estCOP, est_sell_usd:estUSD,
    est_aporte_usd:apUSDunit, est_margin_usd:mgUSD
  });
  await loadInventory(); fillSalesSel(); renderReports();
  alert("Agregado al inventario.");
};

/* ===================== INVENTARIO ===================== */
async function loadInventory(){
  const { data } = await supa.from('products').select('*').eq('trip_id', tripId).order('created_at',{ascending:false});
  inventory = data || [];
  renderInventory(); fillSalesSel();
}
function renderInventory(){
  const tb=$("#invT"); tb.innerHTML="";
  const vUSD = overheads.reduce((s,o)=> s + Number(o.amount_usd||0), 0);
  const aporteAcum = inventory.reduce((s,p)=> s + (Number(p.unit_usd||0)*aportePorDolar()*Number(p.qty||0)), 0);
  const pct = vUSD>0 ? Math.min(100, (aporteAcum/vUSD)*100) : 0;
  $("#invProg").style.width = pct.toFixed(1)+"%";
  $("#invProgText").textContent = `Cobertura de costos: ${pct.toFixed(1)}% (${fmtUSD(aporteAcum)} de ${fmtUSD(vUSD)})`;

  inventory.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.created_at? new Date(p.created_at).toLocaleString('es-CO'):'‚Äî'}</td>
      <td>${p.name||''}</td>
      <td>${p.store||'‚Äî'}</td>
      <td>${p.cat||'‚Äî'}</td>
      <td class="right">${fmtUSD(p.unit_usd||0)} √ó ${p.qty||0}</td>
      <td class="right">${p.est_sell_cop? fmtCOP(p.est_sell_cop):'‚Äî'}</td>
      <td class="right">${fmtUSD(p.est_aporte_usd|| (Number(p.unit_usd||0)*aportePorDolar()))}</td>
      <td class="right">${p.est_margin_usd!=null? fmtUSD(p.est_margin_usd):'‚Äî'}</td>
      <td><button class="btn" data-del="${p.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=async ()=>{ await supa.from('products').delete().eq('id', b.dataset.del); loadInventory(); fillSalesSel(); renderReports(); };
  });
}

/* ===================== VENTAS ===================== */
async function loadSales(){
  const { data } = await supa.from('sales').select('*').eq('trip_id', tripId).order('created_at',{ascending:false});
  sales = data || [];
  renderSales();
}
function fillSalesSel(){
  const sel=$("#saleSel"); sel.innerHTML="";
  inventory.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.id; o.textContent=`${p.name} ‚Äî ${fmtUSD(p.unit_usd)} √ó ${p.qty}${p.store?(' @ '+p.store):''}`;
    sel.appendChild(o);
  });
}
function renderSales(){
  const tb=$("#saleT"); tb.innerHTML="";
  sales.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${s.created_at? new Date(s.created_at).toLocaleString('es-CO'):'‚Äî'}</td>
      <td>${s.product_name||'‚Äî'}</td>
      <td>${s.store||'‚Äî'}</td>
      <td class="right">${s.qty||0}</td>
      <td class="right">${fmtCOP(s.sale_cop||0)}</td>
      <td class="right">${fmtUSD(s.aporte_usd||0)}</td>
      <td class="right">${fmtUSD(s.profit_usd||0)}</td>
      <td><button class="btn" data-del="${s.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=async ()=>{ await supa.from('sales').delete().eq('id', b.dataset.del); loadSales(); renderReports(); };
  });
}
$("#saleAdd").onclick = async ()=>{
  const pid=$("#saleSel").value; const qty=Number($("#saleQty").value||0); const saleCOP=Number($("#saleCOP").value||0);
  const p = inventory.find(x=>String(x.id)===String(pid));
  if(!p||qty<=0||saleCOP<=0){ alert("Completa venta"); return; }
  const apUSDunit = Number(p.unit_usd||0)*aportePorDolar();
  const saleUSDunit = saleCOP/settings.trm_default;
  const profitUSDunit = saleUSDunit - Number(p.unit_usd||0) - apUSDunit;
  await supa.from('sales').insert({
    trip_id:tripId, product_id:p.id, product_name:p.name, store:p.store||null,
    qty, unit_usd:p.unit_usd, trm_used:settings.trm_default,
    sale_cop:saleCOP, aporte_usd: apUSDunit*qty, profit_usd: profitUSDunit*qty
  });
  await loadSales(); renderReports();
  alert("Venta registrada.");
};

/* ===================== REPORTES ===================== */
function renderReports(){
  // Estimado
  let estCOP=0, estCOGS=0, estAp=0, estMg=0;
  inventory.forEach(p=>{
    const q=Number(p.qty||0);
    const apUnit = p.est_aporte_usd!=null? Number(p.est_aporte_usd): (Number(p.unit_usd||0)*aportePorDolar());
    const estUSD = p.est_sell_usd!=null? Number(p.est_sell_usd): (p.est_sell_cop? p.est_sell_cop/settings.trm_default:0);
    const mgUnit = estUSD - Number(p.unit_usd||0) - apUnit;

    estCOGS += Number(p.unit_usd||0)*q;
    estAp   += apUnit*q;
    estMg   += mgUnit*q;
    if(p.est_sell_cop) estCOP += Number(p.est_sell_cop)*q;
  });
  $("#repEst").innerHTML = `
    <div>Ventas estimadas: <b>${fmtCOP(estCOP)}</b></div>
    <div>COGS (USD): <b>${fmtUSD(estCOGS)}</b></div>
    <div>Aporte estimado (USD): <b>${fmtUSD(estAp)}</b></div>
    <div>Margen estimado (USD): <b>${fmtUSD(estMg)}</b></div>
  `;

  // Real
  let rCOP=0, rAp=0, rPf=0;
  sales.forEach(s=>{ rCOP+=Number(s.sale_cop||0); rAp+=Number(s.aporte_usd||0); rPf+=Number(s.profit_usd||0); });
  $("#repReal").innerHTML = `
    <div>Ventas realizadas: <b>${fmtCOP(rCOP)}</b> (${fmtUSD(rCOP/settings.trm_default)})</div>
    <div>Aporte a costos (USD): <b>${fmtUSD(rAp)}</b></div>
    <div>Utilidad (USD): <b>${fmtUSD(rPf)}</b></div>
  `;
}
$("#dlEst").onclick=()=>{
  const rows=[];
  inventory.forEach(p=>{
    const q=Number(p.qty||0);
    const apUnit = p.est_aporte_usd!=null? Number(p.est_aporte_usd): (Number(p.unit_usd||0)*aportePorDolar());
    const estUSD = p.est_sell_usd!=null? Number(p.est_sell_usd): (p.est_sell_cop? p.est_sell_cop/settings.trm_default:0);
    const mgUnit = estUSD - Number(p.unit_usd||0) - apUnit;
    rows.push({
      fecha:p.created_at, producto:p.name, tienda:p.store, cat:p.cat,
      qty:q, unit_usd:p.unit_usd, est_aporte_usd:apUnit, est_margin_usd:mgUnit, est_sell_cop:p.est_sell_cop
    });
  });
  downloadCSV(rows,"reporte_estimado.csv");
};
$("#dlReal").onclick=()=>downloadCSV(sales,"reporte_real.csv");

/* ===================== KPIs, TRM y utilidades ===================== */
function renderKPIs(){
  const vUSD = overheads.reduce((s,o)=> s + Number(o.amount_usd||0), 0);
  $("#kBT").textContent = fmtUSD(settings.bt);
  $("#kV").textContent  = fmtUSD(vUSD);
  $("#kRO").textContent = (settings.bt>0? (vUSD/settings.bt):0).toFixed(3);
  $("#kTRM").textContent = fmtCOP(settings.trm_default) + " COP/USD";
}
$("#btnTRM").onclick = async ()=>{
  try{
    const r = await fetch("https://open.er-api.com/v6/latest/USD");
    const j = await r.json();
    if(j && j.rates && j.rates.COP){
      settings.trm_default = Number(j.rates.COP);
      $("#inpTRM").value = settings.trm_default;
      renderKPIs(); renderInventory(); renderReports();
      alert("TRM UI actualizada.");
    }else throw new Error();
  }catch(e){ alert("No se pudo traer TRM; usa manual."); }
};
$("#btnTRMmanual").onclick=()=>{
  const v = prompt("TRM (COP/USD):", String(settings.trm_default));
  if(v){ settings.trm_default = Number(v); $("#inpTRM").value = settings.trm_default; renderKPIs(); renderInventory(); renderReports(); }
};
$("#btnSync").onclick = ()=> syncAll();

function downloadCSV(arr, name){
  if(!arr || !arr.length){ alert("Sin datos"); return; }
  const keys = Object.keys(arr[0]);
  const csv = [keys.join(",")].concat(arr.map(o=>keys.map(k=>String(o[k]??"").replaceAll(","," ")).join(","))).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = name; a.click();
}

/* ===================== SYNC (carga inicial) ===================== */
async function syncAll(){
  fillCatSelects();
  await Promise.all([loadSettings(), loadOverheads(), loadCatalog(), loadInventory(), loadSales()]);
  renderKPIs(); renderInventory(); renderReports(); fillSalesSel();
}

(async function init(){
  fillCatSelects();
  await loadTrips();
  await syncAll();
})();
</script>
</body>
</html>
