<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Personal Shopper USA</title>

<style>
  :root{
    --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#60a5fa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --chip:#1f2937;
    --card:#0f172a; --accent:#1e293b; --line:#334155;
  }
  html,body{height:100%;}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu;
       background:linear-gradient(120deg,#0a0f1a,#101726,#0d1422); color:var(--text);}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;}
  .brand-row{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .app-title{display:flex;align-items:center;gap:10px}
  .logo{
    width:28px;height:28px;border-radius:8px;background:linear-gradient(145deg,#60a5fa,#22d3ee);
    display:inline-flex;align-items:center;justify-content:center;color:#0b1220;font-weight:900
  }
  .header-card{background:rgba(255,255,255,0.04);border:1px solid #1f2937;border-radius:14px;padding:12px 14px}

  .toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .btn{
    display:inline-flex;align-items:center;gap:6px;
    background:#0f172a;color:var(--text);border:1px solid #334155;border-radius:8px;
    padding:4px 8px;font-size:12px;line-height:1.1;cursor:pointer;white-space:nowrap
  }
  .btn:hover{background:#111827}
  .btn.primary{background:#1d4ed8;border-color:#1d4ed8}
  .btn.success{background:#059669;border-color:#059669}
  .btn.warn{background:#b45309;border-color:#b45309}
  .btn:disabled{opacity:.55;cursor:not-allowed}

  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:repeat(4,1fr)}
  @media(max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:580px){.cards{grid-template-columns:1fr}}

  .card{background:rgba(255,255,255,0.04);border:1px solid #1f2937;border-radius:14px;padding:14px}
  .k{color:var(--muted);font-size:12px}
  .v{font-size:20px;font-weight:700}
  .sub{color:var(--muted);font-size:11px}

  .tabs{display:flex;gap:6px;margin:10px 0 6px}
  .tab{padding:6px 10px;border:1px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:13px}
  .tab.active{background:#1f2937;color:#e5e7eb;border-color:#475569}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}

  .input, select{
    width:100%;background:#0b1220;color:var(--text);border:1px solid #334155;border-radius:10px;padding:10px;
    font-size:14px
  }
  label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left}
  thead th{position:sticky;top:0;background:#0b1220;z-index:1}

  .chip{display:inline-flex;align-items:center;gap:6px;background:#0f172a;border:1px solid #334155;color:#cbd5e1;
        border-radius:999px;padding:2px 8px;font-size:12px}
  .chip.ok{background:rgba(16,185,129,0.12);border-color:#065f46;color:#a7f3d0}
  .chip.warn{background:rgba(245,158,11,0.12);border-color:#78350f;color:#fde68a}
  .chip.bad{background:rgba(239,68,68,0.12);border-color:#7f1d1d;color:#fecaca}

  .progress{height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,#22d3ee,#60a5fa);width:0%}

  .muted{color:var(--muted)}
  .right{text-align:right}
  .center{text-align:center}
  .mt8{margin-top:8px}
  .mt12{margin-top:12px}
  .mt16{margin-top:16px}
  .mt24{margin-top:24px}

  /* Botones TRM/Sync compactos */
  #btnSync, #btnFetchTRM, #btnManualTRM { padding:2px 6px !important; font-size:11px !important; line-height:1.05 !important; border-radius:7px !important;}

  .select-compact{padding:4px 6px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <!-- Encabezado -->
  <div class="header-card">
    <div class="brand-row">
      <div class="app-title">
        <div class="logo">PS</div>
        <div>
          <div style="font-weight:800;font-size:18px">Personal Shopper USA</div>
          <div class="muted" style="font-size:12px">Control de costos, inventario y viabilidad en tiempo real</div>
        </div>
      </div>
      <div class="toolbar">
        <button id="btnSync" class="btn">‚ü≥ Sync</button>
        <button id="btnFetchTRM" class="btn">‚áÖ TRM</button>
        <button id="btnManualTRM" class="btn">‚úç TRM</button>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid cards mt12">
    <div class="card">
      <div class="k">Presupuesto Total (BT) USD</div>
      <div class="v" id="kpiBT">$7,000.00</div>
      <div class="sub" id="kpiBTcop">‚Äî</div>
    </div>
    <div class="card">
      <div class="k">Costos del viaje (Overheads) USD</div>
      <div class="v" id="kpiV">‚Äî</div>
      <div class="sub" id="kpiVcop">‚Äî</div>
    </div>
    <div class="card">
      <div class="k">Aporte por d√≥lar (V/BT)</div>
      <div class="v" id="kpiRO">‚Äî</div>
      <div class="sub muted">Se usa para VSV</div>
    </div>
    <div class="card">
      <div class="k">TRM vigente</div>
      <div class="v" id="kpiTRM">‚Äî</div>
      <div class="sub">Hist√≥rico por d√≠a</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="config">‚öôÔ∏è Configuraci√≥n</div>
    <div class="tab" data-tab="catalog">üìö Cat√°logo referencia</div>
    <div class="tab" data-tab="semaforo">üö¶ Consulta de sem√°foro</div>
    <div class="tab" data-tab="inventario">üì¶ Inventario</div>
    <div class="tab" data-tab="ventas">üíµ Ventas</div>
    <div class="tab" data-tab="reportes">üìä Reportes</div>
  </div>

  <!-- Panel Configuraci√≥n -->
  <div id="panel-config" class="card">
    <div class="row">
      <div>
        <label>Presupuesto total (BT) USD</label>
        <input id="inpBT" class="input" type="number" step="0.01" value="7000">
      </div>
      <div>
        <label>Margen objetivo GB% (sobre venta)</label>
        <input id="inpGB" class="input" type="number" step="1" value="30">
      </div>
      <div>
        <label>TRM (COP/USD) ‚Äì d√≠a de hoy</label>
        <input id="inpTRM" class="input" type="number" step="1" placeholder="Ej: 4200">
      </div>
      <div>
        <label>Notas</label>
        <input id="inpNotes" class="input" placeholder="Opcional">
      </div>
    </div>

    <div class="mt16">
      <div class="k">Costos del viaje (overheads)</div>
      <div class="row">
        <div>
          <label>Descripci√≥n</label>
          <input id="ohDesc" class="input" placeholder="Tiquetes / Hospedaje / Env√≠o...">
        </div>
        <div>
          <label>Categor√≠a</label>
          <select id="ohCat" class="input">
            <option value="">‚Äî elegir ‚Äî</option>
            <option>Transporte</option>
            <option>Hospedaje</option>
            <option>Alimentaci√≥n</option>
            <option>Env√≠o</option>
            <option>Seguro</option>
            <option>Comunicaciones</option>
            <option>Otros</option>
          </select>
        </div>
        <div>
          <label>Valor USD</label>
          <input id="ohUsd" class="input" type="number" step="0.01">
        </div>
        <div style="display:flex;align-items:flex-end">
          <button id="ohAdd" class="btn success">Ôºã Agregar costo</button>
        </div>
      </div>

      <div class="mt8" style="max-height:280px;overflow:auto">
        <table>
          <thead><tr>
            <th>Fecha</th><th>Descripci√≥n</th><th>Categor√≠a</th><th class="right">USD</th><th class="right">COP</th><th class="center">Acciones</th>
          </tr></thead>
          <tbody id="ohTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Panel Cat√°logo -->
  <div id="panel-catalog" class="card" style="display:none">
    <div class="k">Base de referencia (VR) en COP. Se usa para comparar en el sem√°foro.</div>
    <div class="row">
      <div>
        <label>Descripci√≥n / SKU</label>
        <input id="catName" class="input" placeholder="Ej: Nike Air Max 90">
      </div>
      <div>
        <label>Marca / Categor√≠a (opcional)</label>
        <input id="catMeta" class="input" placeholder="Nike / Calzado">
      </div>
      <div>
        <label>Precio referencia (COP)</label>
        <input id="catCOP" class="input" type="number" step="100">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="catAdd" class="btn success">Ôºã Agregar</button>
        <button id="catSync" class="btn">‚ü≥ Refrescar</button>
      </div>
    </div>

    <div class="mt8" style="max-height:300px;overflow:auto">
      <table>
        <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Marca/Cat</th><th class="right">COP</th><th class="center">Acciones</th></tr></thead>
        <tbody id="catTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Sem√°foro -->
  <div id="panel-semaforo" class="card" style="display:none">
    <div class="row">
      <div>
        <label>Producto a evaluar (descripci√≥n)</label>
        <input id="svName" class="input" placeholder="Ej: Nike Air Max 90">
      </div>
      <div>
        <label>Costo compra (USD)</label>
        <input id="svUnitUSD" class="input" type="number" step="0.01">
      </div>
      <div>
        <label>Cantidad</label>
        <input id="svQty" class="input" type="number" step="1" value="1">
      </div>
      <div>
        <label>Tienda</label>
        <input id="svStore" class="input" list="storeList" placeholder="Ej: Nike Factory Orlando">
        <datalist id="storeList"></datalist>
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="svEval" class="btn primary">Calcular sem√°foro</button>
      </div>
    </div>

    <div id="svResult" class="mt12" style="display:none">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr;gap:12px">
        <div class="card">
          <div class="k">Par√°metros</div>
          <div class="mt8">Margen objetivo: <b id="svGB">‚Äî</b></div>
          <div>Aporte por d√≥lar (V/BT): <b id="svRO">‚Äî</b></div>
          <div>TRM: <b id="svTRM">‚Äî</b></div>
        </div>
        <div class="card">
          <div class="k">VSV (PVP sugerido por app)</div>
          <div>VSV USD (unidad): <b id="svVsvUsd">‚Äî</b></div>
          <div>VSV COP (unidad): <b id="svVsvCop">‚Äî</b></div>
          <div class="muted">= costo*(1 + GB% + V/BT)</div>
        </div>
        <div class="card">
          <div class="k">VR (referencia de mercado)</div>
          <div>VR COP (unidad): <b id="svVrCop">‚Äî</b></div>
          <div>Fuente: <b id="svSource">‚Äî</b></div>
          <div class="muted" id="svSourceDetail">‚Äî</div>
        </div>
      </div>
      <div class="mt12">
        <span class="k">Relaci√≥n VSV/VR:</span>
        <span id="svRatio" class="chip">‚Äî</span>
        <span id="svExplain" class="muted" style="margin-left:8px"></span>
      </div>

      <div class="mt16">
        <label>¬øAgregar a inventario? (PVP estimado requerido)</label>
        <div class="row">
          <div>
            <label>Precio estimado de venta (COP, por unidad)</label>
            <input id="svEstSellCOP" class="input" type="number" step="100" placeholder="Ej: 280000">
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px">
            <button id="svAddToInv" class="btn success">Ôºã Incluir en inventario</button>
          </div>
        </div>
        <div class="muted mt8">Se guarda costo, PVP estimado, TIENDA, aporte estimado y margen estimado.</div>
      </div>
    </div>
  </div>

  <!-- Panel Inventario -->
  <div id="panel-inventario" class="card" style="display:none">
    <div class="k">Inventario actual</div>
    <div class="mt8 progress"><div id="invProgress"></div></div>
    <div class="muted" id="invProgressText" style="margin-top:6px">‚Äî</div>

    <div class="mt12" style="max-height:340px;overflow:auto">
      <table>
        <thead><tr>
          <th>Fecha</th><th>Producto</th><th>Cat/Tienda</th>
          <th class="right">Costo USD</th><th class="right">Est. Venta COP</th>
          <th class="right">Est. Aporte USD</th><th class="right">Est. Margen USD</th>
          <th class="center">Acciones</th>
        </tr></thead>
        <tbody id="invTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Ventas -->
  <div id="panel-ventas" class="card" style="display:none">
    <div class="k">Registrar venta</div>
    <div class="row">
      <div>
        <label>Producto (del inventario)</label>
        <select id="saleProduct" class="input select-compact"></select>
      </div>
      <div>
        <label>Cantidad</label>
        <input id="saleQty" class="input" type="number" step="1" value="1">
      </div>
      <div>
        <label>Precio de venta (COP, por unidad)</label>
        <input id="saleCOP" class="input" type="number" step="100">
      </div>
      <div style="display:flex;align-items:flex-end;gap:8px">
        <button id="saleSave" class="btn success">üíæ Guardar venta</button>
      </div>
    </div>

    <div class="mt12" style="max-height:340px;overflow:auto">
      <table>
        <thead><tr>
          <th>Fecha</th><th>Producto</th><th>Cat/Tienda</th><th class="right">Cant.</th>
          <th class="right">PVP (COP)</th><th class="right">Aporte USD</th><th class="right">Utilidad USD</th>
          <th class="center">Acciones</th>
        </tr></thead>
        <tbody id="salesTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Panel Reportes -->
  <div id="panel-reportes" class="card" style="display:none">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <div class="card">
        <div class="k">Reporte estimado (inventario)</div>
        <div id="repEst">‚Äî</div>
      </div>
      <div class="card">
        <div class="k">Reporte realizado (ventas)</div>
        <div id="repReal">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://ucrkhrehdedmubykzfzs.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmtocmVoZGVkbXVieWt6ZnpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTc5MzgsImV4cCI6MjA3NzE3MzkzOH0.7CXUuyAPQlm_9RIKbaO9y8Kwjh9c6M7UJcu4xAIM7WA";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ---- Estado ---- */
let BT = 7000;
let GB = 30;
let TRM = 4200;
let OVERHEADS = [];
let CATALOG = [];
let INVENTORY = [];
let SALES = [];

/* ---- Helpers ---- */
const fmtUSD = n => "$" + (Number(n||0)).toFixed(2);
const fmtCOP = n => "$" + (Math.round(Number(n||0))).toLocaleString("es-CO");
const nowStr = () => new Date().toLocaleString("es-CO");
const aportePorDolar = () => {
  const V = OVERHEADS.reduce((s,o)=>s+Number(o.usd||0),0);
  return BT>0? (V/BT) : 0;
};
const vsvUSD = (unitUSD) => {
  const rO = aportePorDolar();
  const gb = GB/100;
  return Number(unitUSD) * (1 + gb + rO);
};
const toCOP = (usd) => Number(usd)*Number(TRM);

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ---- Tabs ---- */
$$('.tab').forEach(t=>{
  t.onclick=()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    ['config','catalog','semaforo','inventario','ventas','reportes'].forEach(id=>{
      $('#panel-'+id).style.display = (id===tab?'block':'none');
    });
    if(tab==='ventas') fillSaleProducts();
    if(tab==='inventario'){ renderInventory(); }
    if(tab==='reportes'){ renderReports(); }
    if(tab==='semaforo'){ fillStoreDatalist(); }
  };
});

/* ---- KPIs ---- */
function renderKPIs(){
  const V = OVERHEADS.reduce((s,o)=>s+Number(o.usd||0),0);
  $('#kpiBT').textContent = fmtUSD(BT);
  $('#kpiBTcop').textContent = fmtCOP(BT*TRM);
  $('#kpiV').textContent = fmtUSD(V);
  $('#kpiVcop').textContent = fmtCOP(V*TRM);
  $('#kpiRO').textContent = (aportePorDolar()).toFixed(3);
  $('#kpiTRM').textContent = fmtCOP(TRM) + " COP/USD";
}

/* ---- Overheads ---- */
async function loadOverheads(){
  const {data,error} = await supa.from('overheads').select('*').order('created_at',{ascending:false});
  if(!error && data){ OVERHEADS = data; renderOverheads(); renderKPIs(); }
}
function renderOverheads(){
  const tb = $('#ohTbody'); tb.innerHTML="";
  OVERHEADS.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${new Date(o.created_at).toLocaleString('es-CO')}</td>
      <td>${o.description||''}</td>
      <td>${o.cat||''}</td>
      <td class="right">${fmtUSD(o.usd)}</td>
      <td class="right">${fmtCOP(o.usd*TRM)}</td>
      <td class="center"><button class="btn" data-del="${o.id}">üóë Eliminar</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      await supa.from('overheads').delete().eq('id', btn.dataset.del);
      await loadOverheads();
    };
  });
}
$('#ohAdd').onclick = async ()=>{
  const desc = $('#ohDesc').value.trim();
  const cat = $('#ohCat').value.trim();
  const usd = Number($('#ohUsd').value||0);
  if(!desc || !usd){ alert('Ingresa descripci√≥n y valor USD'); return; }
  await supa.from('overheads').insert({description:desc,cat,usd});
  $('#ohDesc').value=''; $('#ohCat').value=''; $('#ohUsd').value='';
  await loadOverheads();
};

/* ---- Cat√°logo ---- */
async function loadCatalog(){
  const {data,error} = await supa.from('catalog').select('*').order('created_at',{ascending:false});
  if(!error && data){ CATALOG = data; renderCatalog(); }
}
function renderCatalog(){
  const tb = $('#catTbody'); tb.innerHTML="";
  CATALOG.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(c.created_at).toLocaleString('es-CO')}</td>
      <td>${c.name||''}</td>
      <td>${(c.brand||'')}${c.cat?(' / '+c.cat):''}</td>
      <td class="right">${fmtCOP(c.ref_cop||0)}</td>
      <td class="center"><button class="btn" data-del="${c.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=async ()=>{
      await supa.from('catalog').delete().eq('id', btn.dataset.del);
      await loadCatalog();
    };
  });
}
$('#catAdd').onclick=async ()=>{
  const name=$('#catName').value.trim();
  const meta=$('#catMeta').value.trim();
  const cop=Number($('#catCOP').value||0);
  if(!name||!cop){ alert('Ingresa descripci√≥n y COP'); return; }
  let brand=null, cat=null;
  if(meta){
    const p = meta.split('/').map(s=>s.trim());
    brand = p[0]||null; cat = p[1]||null;
  }
  await supa.from('catalog').insert({name,brand,cat,ref_cop:cop});
  $('#catName').value=''; $('#catMeta').value=''; $('#catCOP').value='';
  await loadCatalog();
};
$('#catSync').onclick = loadCatalog;

/* ---- Utilidades tiendas ---- */
function uniqueStores(){
  const set = new Set();
  INVENTORY.forEach(p=>{ if(p.store) set.add(p.store); });
  SALES.forEach(s=>{ if(s.store) set.add(s.store); });
  return Array.from(set);
}
function fillStoreDatalist(){
  const dl = $('#storeList'); if(!dl) return;
  dl.innerHTML = "";
  uniqueStores().forEach(st=>{
    const opt = document.createElement('option');
    opt.value = st;
    dl.appendChild(opt);
  });
}

/* ---- B√∫squeda VR ---- */
async function buscarVR(descr){
  const q = descr.toLowerCase();
  let bestCat = null;
  let bestScore = 0;
  CATALOG.forEach(c=>{
    const t = ((c.name||'') + ' ' + (c.brand||'') + ' ' + (c.cat||'')).toLowerCase();
    const words = q.split(/\s+/).filter(w=>w.length>3);
    let score = 0; words.forEach(w=>{ if(t.includes(w)) score+=1; });
    if(score>bestScore){ bestScore=score; bestCat=c; }
  });

  let mlCOP = null, mlDetail = '';
  try{
    const r = await fetch('https://api.mercadolibre.com/sites/MCO/search?q='+encodeURIComponent(descr)+'&limit=5');
    const j = await r.json();
    if(j && j.results && j.results.length){
      const precios = j.results.map(x=>x.price).filter(n=>n>0);
      if(precios.length){
        const sum = precios.reduce((a,b)=>a+b,0);
        mlCOP = Math.round(sum/precios.length);
        mlDetail = j.results.map(x=>x.title).slice(0,3).join(' | ');
      }
    }
  }catch(e){ /* ignore */ }

  let src = '‚Äî', vrCOP = null, srcDetail='';
  const cCOP = bestCat? Number(bestCat.ref_cop||0) : null;
  if(cCOP && mlCOP){ vrCOP = Math.min(cCOP, mlCOP); src = (vrCOP===cCOP?'Cat√°logo':'MercadoLibre'); }
  else if(cCOP){ vrCOP = cCOP; src='Cat√°logo'; }
  else if(mlCOP){ vrCOP = mlCOP; src='MercadoLibre'; }
  if(src==='Cat√°logo' && bestCat){ srcDetail = `${bestCat.name} ${(bestCat.brand?('('+bestCat.brand+')'):'')}`; }
  if(src==='MercadoLibre' && mlDetail){ srcDetail = mlDetail; }

  return { vrCOP, src, srcDetail, catMatch: bestCat };
}

/* ---- Sem√°foro ---- */
$('#svEval').onclick = async ()=>{
  const name = $('#svName').value.trim();
  const unit = Number($('#svUnitUSD').value||0);
  const qty = Number($('#svQty').value||0);
  if(!name || unit<=0 || qty<=0){ alert('Completa nombre, costo y cantidad'); return; }

  const gb = GB/100;
  const ro = aportePorDolar();

  const vsvUsd = vsvUSD(unit);
  const vsvCop = toCOP(vsvUsd);

  const {vrCOP, src, srcDetail} = await buscarVR(name);

  $('#svGB').textContent = (GB.toFixed(0))+'%';
  $('#svRO').textContent = ro.toFixed(3);
  $('#svTRM').textContent = fmtCOP(TRM);
  $('#svVsvUsd').textContent = fmtUSD(vsvUsd);
  $('#svVsvCop').textContent = fmtCOP(vsvCop);
  $('#svVrCop').textContent = vrCOP ? fmtCOP(vrCOP) : '‚Äî';
  $('#svSource').textContent = src;
  $('#svSourceDetail').textContent = srcDetail || '‚Äî';

  let ratioTxt='‚Äî', explain='Sin referencia: ingresa precio manual.';
  const ratioEl = $('#svRatio'); ratioEl.className='chip';
  if(vrCOP){
    const ratio = vsvCop/vrCOP;
    ratioTxt = ratio.toFixed(2);
    if(ratio<0.85){ ratioEl.classList.add('ok'); explain='Verde: competitivo.'; }
    else if(ratio<=0.95){ ratioEl.classList.add('warn'); explain='Amarillo: ajusta/rotaci√≥n.'; }
    else { ratioEl.classList.add('bad'); explain='Rojo: no viable.'; }
  }
  $('#svRatio').textContent=ratioTxt;
  $('#svExplain').textContent = explain;

  $('#svResult').style.display='block';
};

$('#svAddToInv').onclick = async ()=>{
  const name = $('#svName').value.trim();
  const unit = Number($('#svUnitUSD').value||0);
  const qty = Number($('#svQty').value||0);
  const estCOP = Number($('#svEstSellCOP').value||0);
  const store = $('#svStore').value.trim() || null;
  if(!name || unit<=0 || qty<=0 || estCOP<=0){ alert('Completa los campos y el PVP estimado'); return; }

  const estUsdUnit = estCOP / TRM;
  const apUSDunit = unit * aportePorDolar();
  const mgUSDunit = estUsdUnit - unit - apUSDunit;

  const insertObj = {
    name, cat: null, store,
    unit_usd: unit, qty,
    est_sell_cop: estCOP,
    est_sell_usd: estUsdUnit,
    est_aporte_usd: apUSDunit,
    est_margin_usd: mgUSDunit
  };
  let {error} = await supa.from('products').insert(insertObj);
  if(error && error.message && error.message.includes('column "est_')){
    await supa.from('products').insert({name, store, unit_usd:unit, qty});
  }
  await loadInventory();
  fillSaleProducts();
  fillStoreDatalist();
  alert('Art√≠culo agregado al inventario con tienda y PVP estimado.');
  $('#svName').value=''; $('#svUnitUSD').value=''; $('#svQty').value='1'; $('#svEstSellCOP').value=''; $('#svStore').value='';
  $('#svResult').style.display='none';
};

/* ---- Inventario ---- */
async function loadInventory(){
  const {data,error} = await supa.from('products').select('*').order('created_at',{ascending:false});
  if(!error && data){ INVENTORY = data; renderInventory(); fillStoreDatalist(); }
}
function renderInventory(){
  const tb = $('#invTbody'); tb.innerHTML="";
  const V = OVERHEADS.reduce((s,o)=>s+Number(o.usd||0),0);
  const aporteAcumUSD = INVENTORY.reduce((s,p)=>{
    const apUnit = Number(p.unit_usd||0) * aportePorDolar();
    return s + apUnit * Number(p.qty||0);
  },0);
  const prog = Math.min(100, (aporteAcumUSD / V) * 100 || 0);
  $('#invProgress').style.width = prog.toFixed(1)+'%';
  $('#invProgressText').textContent = `Aporte cubierto: ${prog.toFixed(1)}% (${fmtUSD(aporteAcumUSD)} de ${fmtUSD(V)})`;

  INVENTORY.forEach(p=>{
    const estCOP = (p.est_sell_cop!=null)? Number(p.est_sell_cop) : null;
    const estUSD = (p.est_sell_usd!=null)? Number(p.est_sell_usd) : (estCOP? estCOP/TRM : null);
    const apUSDunit = (p.est_aporte_usd!=null)? Number(p.est_aporte_usd) : (Number(p.unit_usd||0)*aportePorDolar());
    const mgUSDunit = (p.est_margin_usd!=null)? Number(p.est_margin_usd) : (estUSD!=null? (estUSD-Number(p.unit_usd||0)-apUSDunit) : null);

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(p.created_at).toLocaleString('es-CO')}</td>
      <td>${p.name||''}</td>
      <td>${(p.cat||'‚Äî')}${p.store?(' / '+p.store):''}</td>
      <td class="right">${fmtUSD(p.unit_usd||0)} √ó ${Number(p.qty||0)}</td>
      <td class="right">${estCOP!=null? fmtCOP(estCOP): '‚Äî'}</td>
      <td class="right">${(mgUSDunit!=null||apUSDunit!=null)? fmtUSD(apUSDunit): '‚Äî'}</td>
      <td class="right">${mgUSDunit!=null? fmtUSD(mgUSDunit): '‚Äî'}</td>
      <td class="center">
        <button class="btn" data-del="${p.id}">üóë</button>
      </td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=async ()=>{
      await supa.from('products').delete().eq('id', btn.dataset.del);
      await loadInventory(); fillSaleProducts();
    };
  });
}

/* ---- Ventas ---- */
async function loadSales(){
  const {data,error} = await supa.from('sales').select('*').order('created_at',{ascending:false});
  if(!error && data){ SALES = data; renderSales(); fillStoreDatalist(); }
}
function fillSaleProducts(){
  const sel = $('#saleProduct'); sel.innerHTML="";
  INVENTORY.forEach(p=>{
    const opt=document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.name} ‚Äî ${fmtUSD(p.unit_usd)} √ó ${p.qty}${p.store?(' @ '+p.store):''}`;
    sel.appendChild(opt);
  });
}
function renderSales(){
  const tb = $('#salesTbody'); tb.innerHTML="";
  SALES.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(s.created_at).toLocaleString('es-CO')}</td>
      <td>${s.product_name||'‚Äî'}</td>
      <td>${(s.cat||'‚Äî')}${s.store?(' / '+s.store):''}</td>
      <td class="right">${s.qty||0}</td>
      <td class="right">${fmtCOP(s.sale_cop||0)}</td>
      <td class="right">${fmtUSD(s.aporte_usd||0)}</td>
      <td class="right">${fmtUSD(s.profit_usd||0)}</td>
      <td class="center"><button class="btn" data-del="${s.id}">üóë</button></td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick=async ()=>{
      await supa.from('sales').delete().eq('id', btn.dataset.del);
      await loadSales();
    };
  });
}

$('#saleSave').onclick = async ()=>{
  const pid = $('#saleProduct').value;
  const p = INVENTORY.find(x=>String(x.id)===String(pid));
  if(!p){ alert('Selecciona un producto'); return; }
  const qty = Number($('#saleQty').value||0);
  const saleCOP = Number($('#saleCOP').value||0);
  if(qty<=0 || saleCOP<=0){ alert('Cantidad y PVP COP > 0'); return; }

  const apUSDunit = Number(p.unit_usd||0)*aportePorDolar();
  const saleUSDunit = saleCOP/TRM;
  const profitUSDunit = saleUSDunit - Number(p.unit_usd||0) - apUSDunit;

  let ins = {
    product_id: p.id,
    product_name: p.name,
    cat: p.cat||null,
    store: p.store||null,
    qty,
    unit_usd: p.unit_usd,
    trm_used: TRM,
    sale_cop: saleCOP,
    aporte_usd: apUSDunit*qty,
    profit_usd: profitUSDunit*qty
  };
  let {error} = await supa.from('sales').insert(ins);
  if(error && error.message && error.message.includes('profit_usd')){
    delete ins.profit_usd;
    await supa.from('sales').insert(ins);
  }
  await loadSales();
  alert('Venta registrada');
  $('#saleQty').value='1'; $('#saleCOP').value='';
  renderReports();
};

/* ---- Reportes ---- */
function renderReports(){
  // Estimado (inventario)
  let estCostUSD=0, estAporteUSD=0, estMarginUSD=0, estVentaCOP=0;
  INVENTORY.forEach(p=>{
    const qty = Number(p.qty||0);
    const apUSDunit = (p.est_aporte_usd!=null)? Number(p.est_aporte_usd) : (Number(p.unit_usd||0)*aportePorDolar());
    const estCOP = (p.est_sell_cop!=null)? Number(p.est_sell_cop) : null;
    const estUSD = (p.est_sell_usd!=null)? Number(p.est_sell_usd) : (estCOP? estCOP/TRM : null);
    const mgUSDunit = (p.est_margin_usd!=null)? Number(p.est_margin_usd) : (estUSD!=null? (estUSD-Number(p.unit_usd||0)-apUSDunit):0);

    estCostUSD += Number(p.unit_usd||0)*qty;
    estAporteUSD += apUSDunit*qty;
    estMarginUSD += (mgUSDunit||0)*qty;
    if(estCOP!=null) estVentaCOP += estCOP*qty;
  });
  $('#repEst').innerHTML = `
    <div>Ventas estimadas: <b>${fmtCOP(estVentaCOP)}</b></div>
    <div>COGS (USD): <b>${fmtUSD(estCostUSD)}</b></div>
    <div>Aporte estimado (USD): <b>${fmtUSD(estAporteUSD)}</b></div>
    <div>Margen estimado (USD): <b>${fmtUSD(estMarginUSD)}</b></div>
  `;

  // Realizado (ventas)
  let realCOP=0, realAporteUSD=0, realProfitUSD=0;
  SALES.forEach(s=>{
    realCOP += Number(s.sale_cop||0);
    realAporteUSD += Number(s.aporte_usd||0);
    realProfitUSD += Number(s.profit_usd||0);
  });
  $('#repReal').innerHTML = `
    <div>Ventas realizadas: <b>${fmtCOP(realCOP)}</b> (${fmtUSD(realCOP/TRM)})</div>
    <div>Aporte a costos (USD): <b>${fmtUSD(realAporteUSD)}</b></div>
    <div>Utilidad (USD): <b>${fmtUSD(realProfitUSD)}</b></div>
  `;
}

/* ---- TRM ---- */
async function fetchTRM(){
  try{
    const r = await fetch('https://open.er-api.com/v6/latest/USD');
    const j = await r.json();
    if(j && j.rates && j.rates.COP){
      TRM = Number(j.rates.COP);
      $('#inpTRM').value = TRM;
      renderKPIs();
      alert('TRM actualizada');
    }else throw new Error('Sin rates');
  }catch(e){
    alert('No se pudo actualizar TRM. Ingresa manual.');
  }
}
$('#btnFetchTRM').onclick=fetchTRM;
$('#btnManualTRM').onclick=()=>{ const v=prompt('TRM (COP/USD):', String(TRM)); if(v){ TRM=Number(v); $('#inpTRM').value=TRM; renderKPIs(); } };
$('#inpTRM').onchange=()=>{ const v=Number($('#inpTRM').value||0); if(v>0){ TRM=v; renderKPIs(); } };

/* ---- Sync ---- */
async function syncAll(){
  await Promise.all([loadOverheads(), loadCatalog(), loadInventory(), loadSales()]);
  renderKPIs(); fillSaleProducts(); renderReports(); fillStoreDatalist();
}
$('#btnSync').onclick = syncAll;

/* ---- Config listeners ---- */
$('#inpBT').onchange=()=>{ BT = Number($('#inpBT').value||7000); renderKPIs(); renderInventory(); renderReports(); };
$('#inpGB').onchange=()=>{ GB = Number($('#inpGB').value||30); };

/* ---- Init ---- */
(async function(){
  BT = Number($('#inpBT').value||7000);
  GB = Number($('#inpGB').value||30);
  TRM = Number($('#inpTRM').value||4200) || 4200;
  renderKPIs();
  await syncAll();
})();
</script>
</body>
</html>

