<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Personal Shopper USA</title>
<style>
  :root{
    --bg:#0b1220; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#60a5fa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --line:#334155;
  }
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu;
       background:linear-gradient(120deg,#0a0f1a,#101726,#0d1422);color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .header{display:flex;justify-content:space-between;align-items:center;gap:8px;
          background:rgba(255,255,255,.04);border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  .logo{display:flex;gap:8px;align-items:center}
  .badge{width:28px;height:28px;border-radius:8px;background:linear-gradient(145deg,#60a5fa,#22d3ee);
         display:inline-flex;align-items:center;justify-content:center;color:#0b1220;font-weight:900}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  .btn{padding:4px 8px;border:1px solid #334155;border-radius:8px;background:#0f172a;color:#e5e7eb;
       font-size:12px;cursor:pointer}
  .btn:hover{background:#111827}
  #btnSync,#btnTRM,#btnTRMman{padding:2px 6px;font-size:11px;border-radius:7px}
  select, input {background:#0b1220;color:var(--text);border:1px solid #334155;border-radius:8px;padding:8px;font-size:14px;width:100%}
  label{font-size:12px;color:var(--muted);display:block;margin:6px 0 4px}
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:repeat(4,1fr)}
  @media(max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:580px){.cards{grid-template-columns:1fr}}
  .card{background:rgba(255,255,255,.04);border:1px solid #1f2937;border-radius:12px;padding:12px}
  .k{color:var(--muted);font-size:12px}
  .v{font-size:20px;font-weight:800}
  .tabs{display:flex;gap:6px;margin:10px 0 6px}
  .tab{padding:6px 10px;border:1px solid #334155;border-radius:10px;background:#0f172a;cursor:pointer;font-size:13px}
  .tab.active{background:#1f2937;border-color:#475569}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #1f2937;padding:8px 6px;text-align:left}
  .right{text-align:right}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #334155;background:#0f172a;border-radius:999px;font-size:12px}
  .progress{height:10px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden}
  .progress>div{height:100%;background:linear-gradient(90deg,#22d3ee,#60a5fa);width:0%}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #334155;background:#0f172a;border-radius:999px;padding:2px 8px;font-size:12px}
  .ok{background:rgba(16,185,129,.12);border-color:#065f46}
  .warn{background:rgba(245,158,11,.12);border-color:#78350f}
  .bad{background:rgba(239,68,68,.12);border-color:#7f1d1d}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.row2{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo">
      <div class="badge">PS</div>
      <div>
        <div style="font-weight:900">Personal Shopper USA</div>
        <div style="font-size:12px;color:#9ca3af">Viajes, costos, inventario y m√°rgenes</div>
      </div>
    </div>
    <div class="toolbar">
      <select id="tripSelect" style="min-width:220px"></select>
      <button id="btnNewTrip" class="btn">Ôºã Nuevo viaje</button>
      <button id="btnDupTrip" class="btn">‚éò Duplicar</button>
      <button id="btnSync" class="btn">‚ü≥ Sync</button>
      <button id="btnTRM" class="btn">‚áÖ TRM</button>
      <button id="btnTRMman" class="btn">‚úç TRM</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid cards" style="margin-top:12px">
    <div class="card"><div class="k">BT (presupuesto estimado)</div><div id="kBT" class="v">‚Äî</div></div>
    <div class="card"><div class="k">Overheads (USD fijos)</div><div id="kV" class="v">‚Äî</div></div>
    <div class="card"><div class="k">rO = V / BT</div><div id="kRO" class="v">‚Äî</div></div>
    <div class="card"><div class="k">TRM UI (por defecto)</div><div id="kTRM" class="v">‚Äî</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="cfg">‚öôÔ∏è Configuraci√≥n</div>
    <div class="tab" data-tab="cat">üìö Cat√°logo</div>
    <div class="tab" data-tab="sem">üö¶ Sem√°foro</div>
    <div class="tab" data-tab="inv">üì¶ Inventario</div>
    <div class="tab" data-tab="sale">üíµ Ventas</div>
    <div class="tab" data-tab="rep">üìä Reportes</div>
  </div>

  <!-- Config -->
  <div id="p-cfg" class="card">
    <div class="row2">
      <div>
        <label>BT (USD) ‚Äì presupuesto estimado</label>
        <input id="iBT" type="number" step="0.01">
      </div>
      <div>
        <label>Margen objetivo (GB%)</label>
        <input id="iGB" type="number" step="1" min="0" max="90">
      </div>
      <div>
        <label>TRM por defecto (para UI y TRM diaria si falta)</label>
        <input id="iTRM" type="number" step="1">
      </div>
      <div style="display:flex;align-items:flex-end;gap:6px">
        <button id="btnSaveCfg" class="btn">üíæ Guardar settings</button>
        <div id="cfgUpd" class="pill">‚Äî</div>
      </div>
    </div>

    <hr style="border-color:#1f2937;margin:12px 0">

    <div class="row2">
      <div>
        <div class="k">Agregar costo del viaje</div>
        <label>Descripci√≥n</label><input id="ovDesc">
        <label>Categor√≠a</label><input id="ovCat" list="catList">
        <datalist id="catList"><option>Transporte</option><option>Hospedaje</option><option>Env√≠o</option><option>Comidas</option><option>Comunicaciones</option><option>Seguro</option><option>Otros</option></datalist>
        <label>Moneda</label><select id="ovCur"><option>USD</option><option>COP</option></select>
        <label>Monto</label><input id="ovAmt" type="number" step="0.01">
        <label>Fecha</label><input id="ovDate" type="date">
        <button id="ovAdd" class="btn" style="margin-top:8px">Ôºã Agregar costo</button>
      </div>
      <div>
        <div class="k">Vista de costos</div>
        <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <span>Mostrar en:</span>
          <button class="btn" id="viewUSD">USD</button>
          <button class="btn" id="viewCOP">COP</button>
        </div>
        <div style="max-height:280px;overflow:auto">
          <table>
            <thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Cat</th><th>Moneda</th><th class="right">Monto</th><th class="right">TRM</th><th></th></tr></thead>
            <tbody id="ovBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Cat√°logo -->
  <div id="p-cat" class="card" style="display:none">
    <div class="row2">
      <div>
        <div class="k">Nueva referencia (VR en COP)</div>
        <label>Producto</label><input id="cName" placeholder="Nike Air ...">
        <label>Marca</label><input id="cBrand" placeholder="Nike">
        <label>Categor√≠a</label><input id="cCat" placeholder="Calzado">
        <label>Precio ref. COP</label><input id="cCOP" type="number" step="100">
        <button id="cAdd" class="btn" style="margin-top:8px">Ôºã Agregar</button>
      </div>
      <div>
        <div class="k">Carga masiva (Excel/CSV)</div>
        <input id="cFile" type="file" accept=".xlsx,.xls,.csv">
        <button id="cImport" class="btn" style="margin-top:8px">‚¨Ü Importar</button>
        <div id="cImpMsg" class="pill" style="margin-top:8px">‚Äî</div>
        <div style="max-height:280px;overflow:auto;margin-top:8px">
          <table>
            <thead><tr><th>Fecha</th><th>Producto</th><th>Marca/Cat</th><th class="right">COP</th><th></th></tr></thead>
            <tbody id="cBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Sem√°foro -->
  <div id="p-sem" class="card" style="display:none">
    <div class="row2">
      <div>
        <label>Descripci√≥n</label><input id="sName">
        <label>Costo unidad (USD)</label><input id="sUSD" type="number" step="0.01">
        <label>Cantidad</label><input id="sQty" type="number" step="1" value="1">
        <label>Tienda</label><input id="sStore" placeholder="Nike Outlet ...">
        <label>Precio venta estimado (COP)</label><input id="sSellCOP" type="number" step="100">
        <button id="sEval" class="btn" style="margin-top:8px">Calcular sem√°foro</button>
        <button id="sAddInv" class="btn" style="margin-top:8px">Ôºã Agregar a inventario</button>
        <div id="sInfo" class="pill" style="margin-top:6px">‚Äî</div>
      </div>
      <div>
        <div class="k">Foto (OCR) y MercadoLibre</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
          <button id="camStart" class="btn">üì∑ Abrir c√°mara</button>
          <button id="camShot" class="btn" disabled>üì∏ Capturar</button>
          <button id="camStop" class="btn" disabled>‚úñ Cerrar</button>
        </div>
        <video id="camVideo" playsinline muted style="width:100%;max-height:260px;border-radius:10px;background:#000"></video>
        <canvas id="camCanvas" style="display:none"></canvas>
        <div id="sVR" class="pill" style="margin-top:6px">VR: ‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Inventario -->
  <div id="p-inv" class="card" style="display:none">
    <div class="k">Inventario del viaje</div>
    <div class="progress" style="margin-top:6px"><div id="invProg"></div></div>
    <div id="invProgTxt" style="color:#9ca3af;margin:6px 0">‚Äî</div>
    <div style="max-height:340px;overflow:auto">
      <table>
        <thead><tr><th>Fecha</th><th>Producto</th><th>Tienda</th><th class="right">Costo USD √ó Qty</th><th class="right">PVP est. COP</th><th class="right">Aporte USD</th><th class="right">Margen USD</th><th></th></tr></thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Ventas -->
  <div id="p-sale" class="card" style="display:none">
    <div class="row2">
      <div>
        <label>Producto del inventario</label><select id="vProd"></select>
      </div>
      <div>
        <label>Cantidad</label><input id="vQty" type="number" step="1" value="1">
      </div>
      <div>
        <label>Precio de venta (COP)</label><input id="vCOP" type="number" step="100">
      </div>
      <div style="display:flex;align-items:flex-end;gap:6px">
        <button id="vSave" class="btn">üíæ Guardar venta</button>
      </div>
    </div>
    <div style="max-height:300px;overflow:auto;margin-top:8px">
      <table>
        <thead><tr><th>Fecha</th><th>Producto</th><th>Tienda</th><th class="right">Cant.</th><th class="right">PVP COP</th><th class="right">Aporte USD</th><th class="right">Utilidad USD</th><th></th></tr></thead>
        <tbody id="vBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Reportes -->
  <div id="p-rep" class="card" style="display:none">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <div class="card"><div class="k">Estimado (inventario)</div><div id="repEst">‚Äî</div></div>
      <div class="card"><div class="k">Real (ventas)</div><div id="repReal">‚Äî</div></div>
    </div>
  </div>
</div>

<!-- UMD libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* =========================
   Supabase config
========================= */
const SUPABASE_URL  = "https://ucrkhrehdedmubykzfzs.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmtocmVoZGVkbXVieWt6ZnpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTc5MzgsImV4cCI6MjA3NzE3MzkzOH0.7CXUuyAPQlm_9RIKbaO9y8Kwjh9c6M7UJcu4xAIM7WA";
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* =========================
   Estado
========================= */
let trips=[], trip_id=null;
let settings={bt_usd:7000, gb_pct:30, default_trm:4200};
let overheads=[], catalog=[], products=[], sales=[];
let costView='USD'; // tabla de costos: USD/COP

/* =========================
   Helpers
========================= */
const $ = s=>document.querySelector(s);
const fmtUSD = n=>"$"+(Number(n||0)).toFixed(2);
const fmtCOP = n=>"$"+(Math.round(Number(n||0))).toLocaleString("es-CO");
const todayStr = ()=> (new Date()).toISOString().slice(0,10);

function rO(){ // V/BT
  const V = overheads.reduce((s,o)=>s+Number(o.amount_usd_fixed||0),0);
  return Number(settings.bt_usd)>0 ? V/Number(settings.bt_usd) : 0;
}

function refreshKPIs(){
  $("#kBT").textContent = fmtUSD(settings.bt_usd);
  $("#kTRM").textContent = fmtCOP(settings.default_trm)+" COP/USD";
  const V = overheads.reduce((s,o)=>s+Number(o.amount_usd_fixed||0),0);
  $("#kV").textContent = fmtUSD(V);
  $("#kRO").textContent = (rO()).toFixed(3);
}

/* =========================
   Viajes
========================= */
async function loadTrips(){
  const {data} = await sb.from('trips').select('*').order('id',{ascending:true});
  trips = data||[];
  const sel=$("#tripSelect"); sel.innerHTML="";
  trips.forEach(t=>{
    const opt=document.createElement('option');
    opt.value=t.id; opt.textContent=t.name;
    sel.appendChild(opt);
  });
  if(!trips.length){
    const {data:ins} = await sb.from('trips').insert({name:'Viaje demo'}).select().single();
    trips=[ins]; 
  }
  trip_id = trip_id || (trips[0] && trips[0].id);
  sel.value = trip_id;
}
$("#tripSelect").onchange = async ()=>{ trip_id = Number($("#tripSelect").value); await syncAll(); };
$("#btnNewTrip").onclick = async ()=>{
  const name = prompt("Nombre del viaje/proyecto:","Orlando Nov 7 2025");
  if(!name) return;
  const {data} = await sb.from('trips').insert({name}).select().single();
  await sb.from('trip_settings').insert({trip_id:data.id, bt_usd:7000, gb_pct:30, default_trm:4200}).select().single();
  trip_id = data.id;
  await syncAll();
};
$("#btnDupTrip").onclick = async ()=>{
  if(!trip_id) return;
  const base = trips.find(t=>t.id==trip_id);
  const name = prompt("Nuevo nombre para duplicado:", base? base.name+" (copia)":"Nuevo viaje");
  if(!name) return;
  const {data:newTrip} = await sb.from('trips').insert({name}).select().single();
  const {data:set} = await sb.from('trip_settings').select('*').eq('trip_id',trip_id).maybeSingle();
  await sb.from('trip_settings').insert({
    trip_id:newTrip.id,
    bt_usd:set?.bt_usd||7000, gb_pct:set?.gb_pct||30, default_trm:set?.default_trm||4200
  });
  trip_id = newTrip.id;
  await syncAll();
};

/* =========================
   Settings (fuente de verdad)
========================= */
async function loadSettings(){
  const {data} = await sb.from('trip_settings').select('*').eq('trip_id',trip_id).maybeSingle();
  if(!data){
    await sb.from('trip_settings').insert({trip_id, bt_usd:7000, gb_pct:30, default_trm:4200});
    return loadSettings();
  }
  settings = data;
  $("#iBT").value = settings.bt_usd;
  $("#iGB").value = settings.gb_pct;
  $("#iTRM").value = settings.default_trm;
  $("#cfgUpd").textContent = "Actualizado: "+new Date(settings.updated_at).toLocaleString("es-CO");
  refreshKPIs();
}
$("#btnSaveCfg").onclick = async ()=>{
  const bt = Number($("#iBT").value||0);
  const gb = Number($("#iGB").value||0);
  const trm= Number($("#iTRM").value||0);
  const {data} = await sb.from('trip_settings').update({bt_usd:bt, gb_pct:gb, default_trm:trm, updated_at:new Date().toISOString()}).eq('trip_id',trip_id).select().single();
  settings=data;
  refreshKPIs(); renderInventory(); renderReports();
  alert("Settings guardados");
};

/* =========================
   TRM diaria
========================= */
async function ensureTRM(d){
  const day = d || todayStr();
  let {data} = await sb.from('trm_daily').select('*').eq('d',day).maybeSingle();
  if(!data){
    // intenta traer de API; si falla usa default_trm
    let trm = Number(settings.default_trm||4200);
    try{
      const r = await fetch('https://open.er-api.com/v6/latest/USD');
      const j = await r.json();
      if(j && j.rates && j.rates.COP) trm = Number(j.rates.COP);
    }catch(e){}
    const ins = await sb.from('trm_daily').insert({d:day,trm}).select().single();
    data = ins.data;
  }
  return data.trm;
}
$("#btnTRM").onclick = async ()=>{
  const t = await ensureTRM(todayStr());
  settings.default_trm = t;
  $("#iTRM").value = t;
  refreshKPIs();
  alert("TRM del d√≠a: "+t);
};
$("#btnTRMman").onclick = async ()=>{
  const v = prompt("TRM manual (COP/USD):", String(settings.default_trm||4200));
  if(!v) return;
  const trm = Number(v);
  await sb.from('trm_daily').upsert({d: todayStr(), trm});
  $("#iTRM").value = trm; settings.default_trm = trm; refreshKPIs();
};

/* =========================
   Overheads (USD/COP con TRM fijada)
========================= */
async function loadOverheads(){
  const {data}=await sb.from('overheads').select('*').eq('trip_id',trip_id).order('created_at',{ascending:false});
  overheads=data||[];
  renderOverheads();
  refreshKPIs();
}
function renderOverheads(){
  const tb=$("#ovBody"); tb.innerHTML="";
  overheads.forEach(o=>{
    const tr=document.createElement('tr');
    const show = (costView==='USD') ? fmtUSD(o.amount_usd_fixed) : fmtCOP(o.amount_cop_fixed);
    tr.innerHTML=`
      <td>${new Date(o.created_at).toLocaleDateString("es-CO")}</td>
      <td>${o.description||''}</td>
      <td>${o.cat||''}</td>
      <td>${o.currency}</td>
      <td class="right">${show}</td>
      <td class="right">${o.trm_used}</td>
      <td><button class="btn" data-del="${o.id}">üóë</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{await sb.from('overheads').delete().eq('id',b.dataset.del); await loadOverheads();});
}
$("#viewUSD").onclick=()=>{costView='USD';renderOverheads();}
$("#viewCOP").onclick=()=>{costView='COP';renderOverheads();}
$("#ovAdd").onclick = async ()=>{
  const desc=$("#ovDesc").value.trim();
  const cat =$("#ovCat").value.trim();
  const cur =$("#ovCur").value;
  const amt =Number($("#ovAmt").value||0);
  const dt  =$("#ovDate").value || todayStr();
  if(!desc || amt<=0){ alert("Completa descripci√≥n/monto"); return; }
  const trm = await ensureTRM(dt);
  let rec={trip_id, description:desc, cat, currency:cur, trm_used:trm, amount_usd:null, amount_cop:null, amount_usd_fixed:0, amount_cop_fixed:0};
  if(cur==='USD'){ rec.amount_usd=amt; rec.amount_usd_fixed=amt; rec.amount_cop_fixed=amt*trm; }
  else{ rec.amount_cop=amt; rec.amount_cop_fixed=amt; rec.amount_usd_fixed=amt/trm; }
  await sb.from('overheads').insert(rec);
  $("#ovDesc").value="";$("#ovCat").value="";$("#ovAmt").value="";
  await loadOverheads();
};

/* =========================
   Cat√°logo + carga masiva
========================= */
async function loadCatalog(){
  const {data}=await sb.from('catalog').select('*').eq('trip_id',trip_id).order('created_at',{ascending:false});
  catalog=data||[];
  const tb=$("#cBody"); tb.innerHTML="";
  catalog.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(c.created_at).toLocaleString("es-CO")}</td>
      <td>${c.name}</td>
      <td>${(c.brand||'') + (c.cat? ' / '+c.cat:'')}</td>
      <td class="right">${fmtCOP(c.ref_cop)}</td>
      <td><button class="btn" data-del="${c.id}">üóë</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{await sb.from('catalog').delete().eq('id',b.dataset.del);await loadCatalog();});
}
$("#cAdd").onclick=async ()=>{
  const name=$("#cName").value.trim();
  const brand=$("#cBrand").value.trim()||null;
  const cat  =$("#cCat").value.trim()||null;
  const cop  =Number($("#cCOP").value||0);
  if(!name||cop<=0){ alert("Producto y COP > 0"); return; }
  await sb.from('catalog').insert({trip_id, name, brand, cat, ref_cop:cop, source:'manual'});
  $("#cName").value="";$("#cBrand").value="";$("#cCat").value="";$("#cCOP").value="";
  await loadCatalog();
};
$("#cImport").onclick=async ()=>{
  const f = $("#cFile").files[0];
  if(!f){ alert("Selecciona un archivo"); return; }
  const data = await f.arrayBuffer();
  const wb = XLSX.read(data,{type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws);
  // columnas esperadas: name, ref_cop (opcional brand, cat)
  let ok=0, fail=0;
  for(const r of json){
    const name=(r.name||r.Nombre||r.Producto||"").toString().trim();
    const ref = Number(r.ref_cop||r.COP||r.precio||0);
    if(!name || !(ref>0)){ fail++; continue; }
    const brand=r.brand||r.marca||null;
    const cat=r.cat||r.categoria||null;
    await sb.from('catalog').insert({trip_id, name, brand, cat, ref_cop:ref, source:'manual'});
    ok++;
  }
  $("#cImpMsg").textContent = `Importadas: ${ok} ¬∑ Rechazadas: ${fail}`;
  await loadCatalog();
};

/* =========================
   Sem√°foro (OCR + ML)
========================= */
function bestCatalogVR(q){
  const query = q.toLowerCase();
  let best=null,bscore=0;
  catalog.forEach(c=>{
    const t = ((c.name||'')+' '+(c.brand||'')+' '+(c.cat||'')).toLowerCase();
    const words = query.split(/\s+/).filter(w=>w.length>3);
    let s=0; words.forEach(w=>{ if(t.includes(w)) s++; });
    if(s>bscore){ bscore=s; best=c; }
  });
  return best? best.ref_cop : null;
}
async function vrFromMercadoLibre(q){
  try{
    const r=await fetch('https://api.mercadolibre.com/sites/MCO/search?q='+encodeURIComponent(q)+'&limit=20');
    const j=await r.json();
    if(!j?.results?.length) return null;
    const arr = j.results.map(x=>x.price).filter(n=>n>0);
    arr.sort((a,b)=>a-b);
    // mediana
    const mid = Math.floor(arr.length/2);
    const vr = arr.length%2 ? arr[mid] : (arr[mid-1]+arr[mid])/2;
    return Math.round(vr);
  }catch(e){ return null; }
}
function vsvUSD(unit){ return Number(unit) * (1 + Number(settings.gb_pct||0)/100 + rO()); }
$("#sEval").onclick = async ()=>{
  const name=$("#sName").value.trim();
  const unit=Number($("#sUSD").value||0);
  if(!name||unit<=0){ alert("Completa nombre y costo USD"); return; }
  const vsv_usd = vsvUSD(unit);
  const vsv_cop = vsv_usd * Number(settings.default_trm||4200);
  let vr = bestCatalogVR(name);
  if(!vr){ vr = await vrFromMercadoLibre(name); }
  const info = (vr? `VSV ${fmtCOP(vsv_cop)} vs VR ${fmtCOP(vr)}` : `VSV ${fmtCOP(vsv_cop)} ¬∑ sin VR`);
  let cls=''; let ratio='‚Äî';
  if(vr){ const r = vsv_cop/vr; ratio=r.toFixed(2); cls = r<0.85?'ok':(r<=0.95?'warn':'bad'); }
  $("#sInfo").className='pill '+cls;
  $("#sInfo").textContent = `Relaci√≥n VSV/VR: ${ratio} ¬∑ ${info}`;
  $("#sVR").textContent = "VR: "+(vr?fmtCOP(vr):"‚Äî");
};
$("#sAddInv").onclick = async ()=>{
  const name=$("#sName").value.trim();
  const unit=Number($("#sUSD").value||0);
  const qty =Number($("#sQty").value||0);
  const store=$("#sStore").value.trim()||null;
  const pvp =Number($("#sSellCOP").value||0);
  if(!name||unit<=0||qty<=0||!pvp){ alert("Completa nombre, USD, qty y PVP estimado"); return; }
  const apUSD = unit * rO();
  const estUSD= pvp / Number(settings.default_trm||4200);
  const mgUSD = estUSD - unit - apUSD;
  await sb.from('products').insert({
    trip_id, name, store, unit_usd:unit, qty,
    est_sell_cop:pvp, est_sell_usd:estUSD, est_aporte_usd:apUSD, est_margin_usd:mgUSD
  });
  await loadProducts(); fillSaleSelect(); renderInventory(); renderReports();
  alert("Inventario actualizado");
  $("#sName").value="";$("#sUSD").value="";$("#sQty").value="1";$("#sStore").value="";$("#sSellCOP").value="";
  $("#sInfo").textContent="‚Äî";
};
/* C√°mara + OCR */
let camStream=null;
$("#camStart").onclick=async()=>{
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
    $("#camVideo").srcObject=camStream; await $("#camVideo").play();
    $("#camShot").disabled=false; $("#camStop").disabled=false;
  }catch(e){ alert("No fue posible abrir la c√°mara (usa HTTPS)"); }
};
$("#camStop").onclick=()=>{ if(camStream){camStream.getTracks().forEach(t=>t.stop()); camStream=null;} $("#camShot").disabled=true; $("#camStop").disabled=true; };
$("#camShot").onclick=async()=>{
  if(!$("#camVideo").videoWidth){ alert("C√°mara no lista"); return; }
  const c=$("#camCanvas"); c.width=$("#camVideo").videoWidth; c.height=$("#camVideo").videoHeight;
  const ctx=c.getContext('2d'); ctx.drawImage($("#camVideo"),0,0,c.width,c.height);
  const data = c.toDataURL('image/png');
  const res = await Tesseract.recognize(data, 'eng+spa');
  const text = res?.data?.text||'';
  if(text){
    // heur√≠stica: primera l√≠nea larga
    const line = text.split('\n').map(s=>s.trim()).filter(Boolean).sort((a,b)=>b.length-a.length)[0]||'';
    if(line.length>4 && !$("#sName").value) $("#sName").value=line;
    $("#sEval").click();
  }
};

/* =========================
   Inventario
========================= */
async function loadProducts(){
  const {data}=await sb.from('products').select('*').eq('trip_id',trip_id).order('created_at',{ascending:false});
  products=data||[];
  renderInventory();
}
function renderInventory(){
  const tb=$("#invBody"); tb.innerHTML="";
  products.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(p.created_at).toLocaleString("es-CO")}</td>
      <td>${p.name}</td>
      <td>${p.store||'‚Äî'}</td>
      <td class="right">${fmtUSD(p.unit_usd)} √ó ${p.qty}</td>
      <td class="right">${p.est_sell_cop?fmtCOP(p.est_sell_cop):'‚Äî'}</td>
      <td class="right">${fmtUSD(p.est_aporte_usd|| (p.unit_usd*rO()))}</td>
      <td class="right">${p.est_margin_usd!=null?fmtUSD(p.est_margin_usd):'‚Äî'}</td>
      <td><button class="btn" data-del="${p.id}">üóë</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{await sb.from('products').delete().eq('id',b.dataset.del); await loadProducts(); renderReports();});
  // progreso cobertura V
  const V = overheads.reduce((s,o)=>s+Number(o.amount_usd_fixed||0),0);
  const aporteInv = products.reduce((s,p)=> s + (Number(p.unit_usd||0)*rO()*Number(p.qty||0)), 0);
  const pct = V>0? Math.min(100,(aporteInv/V)*100):0;
  $("#invProg").style.width = pct.toFixed(1)+"%";
  $("#invProgTxt").textContent = `Cobertura de costos: ${pct.toFixed(1)}% (${fmtUSD(aporteInv)} de ${fmtUSD(V)})`;
}

/* =========================
   Ventas
========================= */
async function loadSales(){
  const {data}=await sb.from('sales').select('*').eq('trip_id',trip_id).order('created_at',{ascending:false});
  sales=data||[];
  renderSales();
}
function fillSaleSelect(){
  const sel=$("#vProd"); sel.innerHTML="";
  products.forEach(p=>{
    const o=document.createElement('option');
    o.value=p.id; o.textContent=`${p.name} ‚Äî ${fmtUSD(p.unit_usd)} √ó ${p.qty} ${p.store?'@ '+p.store:''}`;
    sel.appendChild(o);
  });
}
function renderSales(){
  const tb=$("#vBody"); tb.innerHTML="";
  sales.forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(s.created_at).toLocaleString("es-CO")}</td>
      <td>${s.product_name}</td>
      <td>${s.store||'‚Äî'}</td>
      <td class="right">${s.qty}</td>
      <td class="right">${fmtCOP(s.sale_cop)}</td>
      <td class="right">${fmtUSD(s.aporte_usd)}</td>
      <td class="right">${fmtUSD(s.profit_usd)}</td>
      <td><button class="btn" data-del="${s.id}">üóë</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{await sb.from('sales').delete().eq('id',b.dataset.del); await loadSales(); renderReports();});
}
$("#vSave").onclick=async ()=>{
  const pid = Number($("#vProd").value);
  const p = products.find(x=>x.id==pid);
  if(!p){ alert("Selecciona producto"); return; }
  const qty = Number($("#vQty").value||0);
  const cop = Number($("#vCOP").value||0);
  if(qty<=0 || cop<=0){ alert("Cantidad y PVP>0"); return; }
  const trm = await ensureTRM(todayStr());
  const apUSD = Number(p.unit_usd||0)*rO()*qty;
  const saleUSD = cop/trm*qty;
  const profitUSD = saleUSD - (Number(p.unit_usd||0)*qty) - apUSD;
  await sb.from('sales').insert({
    trip_id, product_id:p.id, product_name:p.name, store:p.store||null,
    qty, unit_usd:p.unit_usd, trm_used:trm, sale_cop:cop, aporte_usd:apUSD, profit_usd:profitUSD
  });
  await loadSales(); renderReports();
  alert("Venta registrada");
};

/* =========================
   Reportes
========================= */
function renderReports(){
  // Estimado
  let estCostUSD=0, estAporteUSD=0, estMarginUSD=0, estVentaCOP=0;
  products.forEach(p=>{
    const qty=Number(p.qty||0);
    const ap = (p.est_aporte_usd!=null)? Number(p.est_aporte_usd): (Number(p.unit_usd||0)*rO());
    const estUSD = (p.est_sell_usd!=null)? Number(p.est_sell_usd): (p.est_sell_cop? Number(p.est_sell_cop)/Number(settings.default_trm||4200):0);
    const mg = (p.est_margin_usd!=null)? Number(p.est_margin_usd): (estUSD-Number(p.unit_usd||0)-ap);
    estCostUSD += Number(p.unit_usd||0)*qty;
    estAporteUSD += ap*qty;
    estMarginUSD += mg*qty;
    if(p.est_sell_cop) estVentaCOP += Number(p.est_sell_cop)*qty;
  });
  $("#repEst").innerHTML = `
    <div>Ventas estimadas: <b>${fmtCOP(estVentaCOP)}</b></div>
    <div>COGS (USD): <b>${fmtUSD(estCostUSD)}</b></div>
    <div>Aporte (USD): <b>${fmtUSD(estAporteUSD)}</b></div>
    <div>Margen (USD): <b>${fmtUSD(estMarginUSD)}</b></div>`;

  // Real
  let realCOP=0, realAporteUSD=0, realProfitUSD=0;
  sales.forEach(s=>{ realCOP += Number(s.sale_cop||0); realAporteUSD += Number(s.aporte_usd||0); realProfitUSD += Number(s.profit_usd||0); });
  $("#repReal").innerHTML = `
    <div>Ventas realizadas: <b>${fmtCOP(realCOP)}</b> (${fmtUSD(realCOP/Number(settings.default_trm||4200))})</div>
    <div>Aporte (USD): <b>${fmtUSD(realAporteUSD)}</b></div>
    <div>Utilidad (USD): <b>${fmtUSD(realProfitUSD)}</b></div>`;
}

/* =========================
   Navegaci√≥n
========================= */
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const id=t.dataset.tab;
  ["cfg","cat","sem","inv","sale","rep"].forEach(k=> $("#p-"+k).style.display=(k===id)?"block":"none");
  if(id==="inv"){ renderInventory(); }
  if(id==="sale"){ fillSaleSelect(); }
  if(id==="rep"){ renderReports(); }
});

/* =========================
   Sync general
========================= */
async function syncAll(){
  await loadTrips(); await loadSettings();
  await Promise.all([loadOverheads(), loadCatalog(), loadProducts(), loadSales()]);
  fillSaleSelect(); renderReports(); refreshKPIs();
}
$("#btnSync").onclick = syncAll;

/* =========================
   Init
========================= */
(async function init(){
  await syncAll();
  // valores por defecto UI
  $("#ovDate").value = todayStr();
})();
</script>
</body>
</html>
