<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PS ¬∑ Viajes/Arbitraje</title>
<meta name="theme-color" content="#0b0f14"/>
<style>
  :root { color-scheme: dark; --bg:#0b0f14; --panel:#121821; --txt:#e6edf3; --muted:#94a3b8; --brand:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#1f2937; }
  *{box-sizing:border-box} body{margin:0;font:14px/1.4 ui-sans-serif,system-ui,Segoe UI,Roboto,Inter;background:var(--bg);color:var(--txt)}
  header{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,15,20,.8);backdrop-filter:saturate(160%) blur(8px)}
  .logo{font-weight:700;letter-spacing:.3px}
  select, input, button, textarea{background:#0f1620;border:1px solid #223043;color:var(--txt);padding:8px 10px;border-radius:10px}
  button{cursor:pointer}
  button.small{padding:6px 8px;font-size:12px}
  .primary{background:linear-gradient(180deg,#1e293b,#0f172a);border-color:#293445}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .cols-4{grid-template-columns:repeat(4,1fr)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .kpi{display:flex;flex-direction:column;gap:6px}
  .kpi b{font-size:18px}
  nav.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 12px}
  nav.tabs button{border-radius:12px}
  .tab{display:none;margin:12px}
  .tab.active{display:block}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:left;vertical-align:top}
  th{color:#cbd5e1;font-weight:600}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .grow{flex:1}
  .right{margin-left:auto}
  .danger{color:var(--err)}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .pill{padding:3px 8px;border:1px solid #2a3a51;border-radius:999px;color:#cbd5e1;font-size:12px}
  .toggle{display:inline-flex;gap:6px;align-items:center}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0f1620;border-radius:8px;padding:2px 6px}
  .hidden{display:none!important}
  .hr{height:1px;background:#1f2937;margin:8px 0}
  .img-preview{max-width:200px;max-height:160px;border:1px dashed #334155;border-radius:10px;object-fit:contain}
</style>
</head>
<body>

<header>
  <div class="logo">üÖøÔ∏èüÜÇ <span class="muted">Arbitraje</span></div>
  <select id="tripSelect"></select>
  <button id="btnNewTrip" class="small primary">+ Nuevo viaje</button>
  <button id="btnDupTrip" class="small">‚éò Duplicar‚Ä¶</button>
  <span class="right"></span>
  <span class="muted small">Moneda vista:</span>
  <div class="toggle">
    <button id="viewUSD" class="small pill">USD</button>
    <button id="viewCOP" class="small pill">COP</button>
  </div>
  <button id="btnSync" class="small">‚ü≥ Sync</button>
  <button id="btnTRM" class="small">‚áÖ TRM (hoy)</button>
</header>

<div class="grid cols-4" style="padding:12px">
  <div class="panel kpi"><span class="muted">BT (USD)</span><b id="kpiBT">‚Äî</b><span class="muted" id="kpiUpdated">Actualizado: ‚Äî</span></div>
  <div class="panel kpi"><span class="muted">Overheads</span><b id="kpiOV">‚Äî</b><span class="muted">rO = Overheads / BT</span><b id="kpiRO">‚Äî</b></div>
  <div class="panel kpi"><span class="muted">Compras acumuladas</span><b id="kpiCompras">‚Äî</b><span class="muted">Vista: <span id="lblVista"></span></span></div>
  <div class="panel kpi"><span class="muted">TRM del d√≠a</span><b id="kpiTRM">‚Äî</b><span class="muted">Fijada por registro</span></div>
</div>

<!-- scripts principales -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
/*** ===========================
 * CONFIG SUPABASE (REAL)
 * ============================*/
const SUPABASE_URL = 'https://ucrkhrehdedmubykzfzs.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjcmtocmVoZGVkbXVieWt6ZnpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1OTc5MzgsImV4cCI6MjA3NzE3MzkzOH0.7CXUuyAPQlm_9RIKbaO9y8Kwjh9c6M7UJcu4xAIM7WA';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: false } });

/*** ===========================
 * PRUEBA DE CONEXI√ìN
 * ============================*/
(async function connectivitySelfTest(){
  try {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/`, {
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
      mode: 'cors',
    });
    console.log('REST ping status:', r.status, r.statusText);
    if (!r.ok) alert('Supabase responde pero con error ' + r.status);
  } catch (e) {
    console.error('REST ping failed:', e);
    alert('Error de conexi√≥n con Supabase:\n' + e);
  }
})();

/*** ===========================
 * CARGA DE VIAJES (TEST SIMPLE)
 * ============================*/
(async function loadTrips(){
  try {
    const { data, error } = await sb.from('trips').select('*').order('created_at',{ascending:false});
    if (error) throw error;
    if (!data.length) {
      await sb.from('trips').insert({ name: 'Orlando Nov 7 2025' });
      alert('‚úÖ Se cre√≥ el viaje inicial en Supabase.');
    } else {
      alert('‚úÖ Conexi√≥n OK, viajes cargados: ' + data.length);
      console.log(data);
    }
  } catch (err) {
    alert('Error cargando viajes: ' + err);
    console.error(err);
  }
})();
</script>
</body>
</html>

